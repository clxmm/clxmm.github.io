<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>17Redlock算法和缓存淘汰 | clxmm</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/icon.jpeg">
    <meta name="description" content="111">
    <meta name="keywords" content="clxmm">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.91c54501.css" as="style"><link rel="preload" href="/assets/js/app.ea6e1e7a.js" as="script"><link rel="preload" href="/assets/js/2.c9184447.js" as="script"><link rel="preload" href="/assets/js/3.b86c239d.js" as="script"><link rel="preload" href="/assets/js/27.b1757049.js" as="script"><link rel="prefetch" href="/assets/js/10.3bb44866.js"><link rel="prefetch" href="/assets/js/11.f29116e0.js"><link rel="prefetch" href="/assets/js/12.eaa80fe1.js"><link rel="prefetch" href="/assets/js/13.607f8a97.js"><link rel="prefetch" href="/assets/js/14.715b1c48.js"><link rel="prefetch" href="/assets/js/15.71d2dbc1.js"><link rel="prefetch" href="/assets/js/16.b263764f.js"><link rel="prefetch" href="/assets/js/17.7201f4e6.js"><link rel="prefetch" href="/assets/js/18.94bf12e5.js"><link rel="prefetch" href="/assets/js/19.416a156a.js"><link rel="prefetch" href="/assets/js/20.33931d01.js"><link rel="prefetch" href="/assets/js/21.8e58e1f5.js"><link rel="prefetch" href="/assets/js/22.e5a8bb91.js"><link rel="prefetch" href="/assets/js/23.b24b112f.js"><link rel="prefetch" href="/assets/js/24.98b533de.js"><link rel="prefetch" href="/assets/js/25.0bc0ae20.js"><link rel="prefetch" href="/assets/js/26.2c564d65.js"><link rel="prefetch" href="/assets/js/28.1cc196ce.js"><link rel="prefetch" href="/assets/js/29.86f67f48.js"><link rel="prefetch" href="/assets/js/30.c88df1af.js"><link rel="prefetch" href="/assets/js/31.0374d8b8.js"><link rel="prefetch" href="/assets/js/32.421193da.js"><link rel="prefetch" href="/assets/js/33.7f87d144.js"><link rel="prefetch" href="/assets/js/34.c88e303d.js"><link rel="prefetch" href="/assets/js/35.68f62f5c.js"><link rel="prefetch" href="/assets/js/36.ffa2d955.js"><link rel="prefetch" href="/assets/js/37.4bfc5d2e.js"><link rel="prefetch" href="/assets/js/4.36c81dcf.js"><link rel="prefetch" href="/assets/js/5.2e4cbb9e.js"><link rel="prefetch" href="/assets/js/6.7b582dbb.js"><link rel="prefetch" href="/assets/js/7.ac6d362f.js"><link rel="prefetch" href="/assets/js/8.e1180ebd.js"><link rel="prefetch" href="/assets/js/9.058f530e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.91c54501.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">clxmm</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端学习" class="dropdown-title"><a href="/java/" class="link-title">后端学习</a> <span class="title" style="display:none;">后端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>01redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b54/" class="nav-link">01redis开始</a></li></ul></li><li class="dropdown-item"><h4>02redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b51/" class="nav-link">01redis开始</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习" class="dropdown-title"><a href="/web/" class="link-title">前端学习</a> <span class="title" style="display:none;">前端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/7f2831/" class="nav-link">01vue学习</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/other/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>centos安装zsh</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/435ca7/" class="nav-link">centos安装zsh</a></li></ul></li></ul></div></div> <a href="https://github.com/clxmm/clxmm" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端学习" class="dropdown-title"><a href="/java/" class="link-title">后端学习</a> <span class="title" style="display:none;">后端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>01redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b54/" class="nav-link">01redis开始</a></li></ul></li><li class="dropdown-item"><h4>02redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b51/" class="nav-link">01redis开始</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习" class="dropdown-title"><a href="/web/" class="link-title">前端学习</a> <span class="title" style="display:none;">前端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/7f2831/" class="nav-link">01vue学习</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/other/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>centos安装zsh</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/435ca7/" class="nav-link">centos安装zsh</a></li></ul></li></ul></div></div> <a href="https://github.com/clxmm/clxmm" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>redis</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/356b54/" class="sidebar-link">01redis</a></li><li><a href="/pages/2a37ab/" class="sidebar-link">02redis持久化</a></li><li><a href="/pages/f01e54/" class="sidebar-link">03redis事务和管道</a></li><li><a href="/pages/75cece/" class="sidebar-link">04redis发布与订阅</a></li><li><a href="/pages/4a54cc/" class="sidebar-link">05Redis复制(replica)</a></li><li><a href="/pages/9788da/" class="sidebar-link">06Redis哨兵(sentinel)</a></li><li><a href="/pages/551b67/" class="sidebar-link">07Redis集群(cluster)</a></li><li><a href="/pages/ebe3c7/" class="sidebar-link">08redis与SpringBoot集成</a></li><li><a href="/pages/fa5943/" class="sidebar-link">redis单线程与多线程</a></li><li><a href="/pages/ec796f/" class="sidebar-link">redis的BigKey</a></li><li><a href="/pages/e53d85/" class="sidebar-link">redis缓存双写一致性</a></li><li><a href="/pages/a32a66/" class="sidebar-link">12redis与mysql双写一致性</a></li><li><a href="/pages/8249db/" class="sidebar-link">13案列bitmap-hyperlog-geo</a></li><li><a href="/pages/d7b34c/" class="sidebar-link">14布隆过滤器BloomFilter</a></li><li><a href="/pages/cdc2c8/" class="sidebar-link">缓存预热、雪崩、击穿、穿透</a></li><li><a href="/pages/6b15da/" class="sidebar-link">redis的分布式锁</a></li><li><a href="/pages/6be928/" aria-current="page" class="active sidebar-link">17Redlock算法和缓存淘汰</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/6be928/#_1-接v8-0" class="sidebar-link">1.接v8.0</a></li><li class="sidebar-sub-header level2"><a href="/pages/6be928/#_2-redis分布式锁-redlock红锁算法" class="sidebar-link">2.Redis分布式锁-Redlock红锁算法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/6be928/#_2-1-官网" class="sidebar-link">2.1 官网</a></li><li class="sidebar-sub-header level3"><a href="/pages/6be928/#_2-2-为什么" class="sidebar-link">2.2 为什么</a></li><li class="sidebar-sub-header level3"><a href="/pages/6be928/#_2-3-redlock算法设计理念" class="sidebar-link">2.3 Redlock算法设计理念</a></li><li class="sidebar-sub-header level3"><a href="/pages/6be928/#_2-4-代码实现-v9-0" class="sidebar-link">2.4 代码实现-v9.0</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/6be928/#_3-redisson-源码" class="sidebar-link">3.Redisson 源码</a></li><li class="sidebar-sub-header level2"><a href="/pages/6be928/#_4-多机案列" class="sidebar-link">4.多机案列</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/6be928/#_4-1-理论来源" class="sidebar-link">4.1 理论来源</a></li><li class="sidebar-sub-header level3"><a href="/pages/6be928/#_4-2-代码参考" class="sidebar-link">4.2 代码参考</a></li><li class="sidebar-sub-header level3"><a href="/pages/6be928/#_4-3-案列" class="sidebar-link">4.3 案列</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/6be928/#_5-redis缓存过期淘汰策略" class="sidebar-link">5.redis缓存过期淘汰策略</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/6be928/#_5-1-面试题" class="sidebar-link">5.1 面试题</a></li><li class="sidebar-sub-header level3"><a href="/pages/6be928/#_5-2-redis内存设置" class="sidebar-link">5.2 redis内存设置</a></li><li class="sidebar-sub-header level3"><a href="/pages/6be928/#_5-3-redis的数据是如何删除的" class="sidebar-link">5.3 redis的数据是如何删除的</a></li><li class="sidebar-sub-header level3"><a href="/pages/6be928/#_5-4-redis缓存淘汰策略" class="sidebar-link">5.4 redis缓存淘汰策略</a></li></ul></li></ul></li><li><a href="/pages/086c39/" class="sidebar-link">18Redis源码</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>redis02</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/java/#后端学习" data-v-06970110>后端学习</a></li><li data-v-06970110><a href="/java/#redis" data-v-06970110>redis</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/clxmm" target="_blank" title="作者" class="beLink" data-v-06970110>clxmm</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2024-11-12</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><!---->17Redlock算法和缓存淘汰<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="_1-接v8-0"><a href="#_1-接v8-0" class="header-anchor">#</a> 1.接v8.0</h2> <ul><li>自研一把分布式锁，面试中回答的主要考点
<ul><li>按照JUC里面java.util.concurrent.locks.Lock接口规范编写</li> <li>lock()加锁关键逻辑
<ul><li>加锁：加锁实际上就是在redis中，给Key键设置一个值，为避免死锁，并给定一个过期时间</li> <li>自旋</li> <li>续期</li></ul></li> <li>unlock解锁关键逻辑
<ul><li>将Key键删除。但也不能乱删，不能说客户端1的请求将客户端2的锁给删除掉，只能自己删除自己的锁</li></ul></li></ul></li></ul> <h2 id="_2-redis分布式锁-redlock红锁算法"><a href="#_2-redis分布式锁-redlock红锁算法" class="header-anchor">#</a> 2.Redis分布式锁-Redlock红锁算法</h2> <h3 id="_2-1-官网"><a href="#_2-1-官网" class="header-anchor">#</a> 2.1 官网</h3> <p><a href="https://redis.io/docs/latest/develop/use/patterns/distributed-locks/#why-failover-based-implementations-are-not-enough" target="_blank" rel="noopener noreferrer">Redis 的分布式锁 |文档 --- Distributed Locks with Redis | Docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_2-2-为什么"><a href="#_2-2-为什么" class="header-anchor">#</a> 2.2 为什么</h3> <p><strong>之前我们手写的分布式锁有什么缺点？</strong></p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411122131596.png" style="zoom:50%;"> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411122132797.png" style="zoom:80%;"> <p>demo</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411122133872.png" alt=""></p> <ul><li>线程 1 首先获取锁成功，将键值对写入 redis 的 master 节点，在 redis 将该键值对同步到 slave 节点之前，master 发生了故障；redis 触发故障转移，其中一个 slave 升级为新的 master，此时新上位的master并不包含线程1写入的键值对，因此线程 2 尝试获取锁也可以成功拿到锁，此时相当于有两个线程获取到了锁，可能会导致各种预期之外的情况发生，例如最常见的脏数据。</li> <li>我们加的是排它独占锁，同一时间只能有一个建redis锁成功并持有锁，严禁出现2个以上的请求线程拿到锁。危险的</li></ul> <h3 id="_2-3-redlock算法设计理念"><a href="#_2-3-redlock算法设计理念" class="header-anchor">#</a> 2.3 Redlock算法设计理念</h3> <ul><li><p>redis之父提出了Redlock算法解决这个问题：Redis也提供了Redlock算法，用来实现<strong>基于多个实例的</strong>分布式锁。锁变量由多个实例维护，即使有实例发生了故障，锁变量仍然是存在的，客户端还是可以完成锁操作。Redlock算法是实现高可靠分布式锁的一种有效解决方案，可以在实际开发中使用。最下方还有笔记</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411122159476.png" style="zoom:67%;"> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411122159900.png" alt=""></p></li> <li><p>设计理念</p> <p>该方案也是基于（set 加锁、Lua 脚本解锁）进行改良的，所以redis之父antirez 只描述了差异的地方，大致方案如下。</p> <p>假设我们有N个Redis主节点，例如 N = 5这些节点是完全独立的，我们不使用复制或任何其他隐式协调系统，</p> <p>为了取到锁客户端执行以下操作：</p> <table><thead><tr><th>获取当前时间，以毫秒为单位；</th></tr></thead> <tbody><tr><td>依次尝试从5个实例，使用相同的 key 和随机值（例如 UUID）获取锁。当向Redis 请求获取锁时，客户端应该设置一个超时时间，这个超时时间应该小于锁的失效时间。例如你的锁自动失效时间为 10 秒，则超时时间应该在 5-50 毫秒之间。这样可以防止客户端在试图与一个宕机的 Redis 节点对话时长时间处于阻塞状态。如果一个实例不可用，客户端应该尽快尝试去另外一个 Redis 实例请求获取锁；</td></tr> <tr><td>客户端通过当前时间减去步骤 1 记录的时间来计算获取锁使用的时间。当且仅当从大多数（N/2+1，这里是 3 个节点）的 Redis 节点都取到锁，并且获取锁使用的时间小于锁失效时间时，锁才算获取成功；</td></tr> <tr><td>如果取到了锁，其真正有效时间等于初始有效时间减去获取锁所使用的时间（步骤 3 计算的结果）。</td></tr> <tr><td>如果由于某些原因未能获得锁（无法在至少 N/2 + 1 个 Redis 实例获取锁、或获取锁的时间超过了有效时间），客户端应该在所有的 Redis 实例上进行解锁（即便某些Redis实例根本就没有加锁成功，防止某些节点获取到锁但是客户端没有得到响应而导致接下来的一段时间不能被重新获取锁）。</td></tr></tbody></table> <p>该方案为了解决数据不一致的问题，直接舍弃了异步复制只使用 master 节点，同时由于舍弃了 slave，为了保证可用性，引入了 N 个节点，官方建议是 5。阳哥本次教学演示用3台实例来做说明。</p> <p>客户端只有在满足下面的这两个条件时，才能认为是加锁成功。</p> <p>条件1：客户端从超过半数（大于等于N/2+1）的Redis实例上成功获取到了锁；</p> <p>条件2：客户端获取锁的总耗时没有超过锁的有效时间。</p></li> <li><p>实现</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411122202481.png" alt=""></p> <p>为什么是奇数？ N = 2X + 1  (N是最终部署机器数，X是容错机器数)</p> <ol><li><p>先知道什么是容错</p> <p>失败了多少个机器实例后我还是可以容忍的，所谓的容忍就是数据一致性还是可以Ok的，CP数据一致性还是可以满足；</p> <p>加入在集群环境中，redis失败1台，可接受。2X+1 = 2 * 1+1 =3，部署3台，死了1个剩下2个可以正常工作，那就部署3台。</p> <p>加入在集群环境中，redis失败2台，可接受。2X+1 = 2 * 2+1 =5，部署5台，死了2个剩下3个可以正常工作，那就部署5台。</p></li> <li><p>为什么是奇数？</p> <p>最少的机器，最多的产出效果</p> <p>加入在集群环境中，redis失败1台，可接受。2N+2= 2 * 1+2 =4，部署4台</p> <p>加入在集群环境中，redis失败2台，可接受。2N+2 = 2 * 2+2 =6，部署6台</p></li></ol></li></ul> <h3 id="_2-4-代码实现-v9-0"><a href="#_2-4-代码实现-v9-0" class="header-anchor">#</a> 2.4 代码实现-v9.0</h3> <p>Redisson是java的redis客户端之一，提供了一些api方便操作redis</p> <p><a href="https://redisson.org/" target="_blank" rel="noopener noreferrer">官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>操作文档：<a href="https://redisson.org/docs/data-and-services/locks-and-synchronizers/" target="_blank" rel="noopener noreferrer">Distributed locks and synchronizers - Redisson Reference Guide<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li><p>POM</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token comment">&lt;!--redisson--&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.13.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li> <li><p>config</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//单Redis节点模式</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">Redisson</span> <span class="token function">redisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token string">&quot;redis://192.168.1.102:6379&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setDatabase</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span><span class="token string">&quot;123456abc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Redisson</span><span class="token punctuation">)</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li> <li><p>controller</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Operation</span><span class="token punctuation">(</span>summary <span class="token operator">=</span> <span class="token string">&quot;扣减库存saleByRedisson，一次卖一个&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/inventory/saleByRedisson&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">saleByRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> inventoryService<span class="token punctuation">.</span><span class="token function">saleByRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li> <li><p>service</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token comment">/**
     * V9.0  Redisson
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">saleByRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> retMessage <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;zzyyRedisLock&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> redissonLock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redissonLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//1 查询库存信息</span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;inventory001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2 判断库存是否足够</span>
            <span class="token class-name">Integer</span> inventoryNumber <span class="token operator">=</span> result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3 扣减库存</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>inventoryNumber <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;inventory001&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>inventoryNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                retMessage <span class="token operator">=</span> <span class="token string">&quot;成功卖出一个商品，库存剩余: &quot;</span> <span class="token operator">+</span> inventoryNumber<span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>retMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                retMessage <span class="token operator">=</span> <span class="token string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            redissonLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> retMessage <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;服务端口号：&quot;</span> <span class="token operator">+</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div></li> <li><p>test</p> <p>api测试</p></li></ul> <p>bug：<img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411182153134.png" alt=""></p> <p>java-cde-v9.1</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * V9.1  Redisson
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">saleByRedisson</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> retMessage <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;zzyyRedisLock&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> redissonLock <span class="token operator">=</span> redisson<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redissonLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//1 查询库存信息</span>
            <span class="token class-name">String</span> result <span class="token operator">=</span> stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;inventory001&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//2 判断库存是否足够</span>
            <span class="token class-name">Integer</span> inventoryNumber <span class="token operator">=</span> result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//3 扣减库存</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>inventoryNumber <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                stringRedisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;inventory001&quot;</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token operator">--</span>inventoryNumber<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                retMessage <span class="token operator">=</span> <span class="token string">&quot;成功卖出一个商品，库存剩余: &quot;</span> <span class="token operator">+</span> inventoryNumber<span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>retMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                retMessage <span class="token operator">=</span> <span class="token string">&quot;商品卖完了，o(╥﹏╥)o&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">// 判断是自己的锁</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>redissonLock<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> redissonLock<span class="token punctuation">.</span><span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                redissonLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> retMessage <span class="token operator">+</span> <span class="token string">&quot;\t&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;服务端口号：&quot;</span> <span class="token operator">+</span> port<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><h2 id="_3-redisson-源码"><a href="#_3-redisson-源码" class="header-anchor">#</a> 3.Redisson 源码</h2> <p>加锁-可重入-续命-解锁</p> <ul><li><p>Redis 分布式锁过期了，但是业务逻辑还没处理完怎么办</p></li> <li><p>守护线程“续命”</p> <ul><li>额外起一个线程，定期检查线程是否还持有锁，如果有则延长过期时间。Redisson 里面就实现了这个方案，使用“看门狗”定期检查（每1/3的锁时间检查1次），如果线程还持有锁，则刷新过期时间；</li></ul></li> <li><p>在获取锁成功后，给锁加一个 watchdog，watchdog会起一个定时任务，在锁没有被释放且快要过期的时候会续期</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411192134744.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411192133070.png" alt=""></p></li> <li><p>上述源码分析1-通过redisson新建出来的锁key，默认是30秒</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411192135391.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411192135440.png" alt=""></p></li> <li><p>上述源码分析2：RedissonLock.java，lock()---tryAcquire()---tryAcquireAsync()---</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411192136982.png" alt=""></p></li> <li><p>上述源码分析3</p> <ul><li>通过exists判断，如果锁不存在，则设置值和过期时间，加锁成功</li> <li>通过hexists判断，如果锁已存在，并且锁的是当前线程，则证明是重入锁，加锁成功</li> <li>如果锁已存在，但锁的不是当前线程，则证明有其他线程持有锁。返回当前锁的过期时间(代表了锁key的剩余生存时间)，加锁失败</li></ul> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411192137962.png" alt=""></p></li> <li><p>上述源码分析4</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411192138152.png" alt=""></p> <p>这里面初始化了一个定时器，dely 的时间是 internalLockLeaseTime/3。在 Redisson 中，internalLockLeaseTime 是 30s，也就是每隔 10s 续期一次，每次 30s。</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411192142994.png" alt=""></p> <ul><li><p>watch dog自动延期机制：客户端A加锁成功，就会启动一个watch dog看门狗，他是一个后台线程，会每隔10秒检查一下，如果客户端A还持有锁key，那么就会不断的延长锁key的生存时间，默认每次续命又从30秒新开始</p></li> <li><p>自动续期lua脚本分析</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis.png" alt=""></p></li></ul></li></ul> <h2 id="_4-多机案列"><a href="#_4-多机案列" class="header-anchor">#</a> 4.多机案列</h2> <h3 id="_4-1-理论来源"><a href="#_4-1-理论来源" class="header-anchor">#</a> 4.1 理论来源</h3> <ul><li><p>算法解决这个问题</p></li> <li><p>官网：</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411232003729.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411232003698.png" alt=""></p></li> <li><p>总结：</p> <p>这个锁的算法实现了多redis实例的情况，相对于单redis节点来说，优点在于 防止了 单节点故障造成整个服务停止运行的情况且在多节点中锁的设计，及多节点同时崩溃等各种意外情况有自己独特的设计方法。</p> <p>Redisson 分布式锁支持 MultiLock 机制可以将多个锁合并为一个大锁，对一个大锁进行统一的申请加锁以及释放锁。</p> <p>最低保证分布式锁的有效性及安全性的要求如下：</p> <ol><li>1.互斥；任何时刻只能有一个client获取锁</li> <li>2.释放死锁；即使锁定资源的服务崩溃或者分区，仍然能释放锁</li> <li>3.容错性；只要多数redis节点（一半以上）在使用，client就可以获取和释放锁</li></ol> <p>网上讲的基于故障转移实现的redis主从无法真正实现Redlock:</p> <p>因为redis在进行主从复制时是异步完成的，比如在clientA获取锁后，主redis复制数据到从redis过程中崩溃了，导致没有复制到从redis中，然后从redis选举出一个升级为主redis,造成新的主redis没有clientA 设置的锁，这是clientB尝试获取锁，并且能够成功获取锁，导致互斥失效；</p></li></ul> <h3 id="_4-2-代码参考"><a href="#_4-2-代码参考" class="header-anchor">#</a> 4.2 代码参考</h3> <p>https://github.com/redisson/redisson/wiki/8.-Distributed-locks-and-synchronizers</p> <h3 id="_4-3-案列"><a href="#_4-3-案列" class="header-anchor">#</a> 4.3 案列</h3> <p>docker启动3个redis</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> registry.cn<span class="token punctuation">-</span>hangzhou.aliyuncs.com/zhengqing/redis<span class="token punctuation">:</span>7.0.5                    <span class="token comment"># 镜像'redis:7.0.5'</span>
    <span class="token key atrule">container_name</span><span class="token punctuation">:</span> redis82                                                             <span class="token comment"># 容器名为'redis'</span>
<span class="token comment">#    restart: unless-stopped                                                                   # 指定容器退出后的重启策略为始终重启，但是不考虑在Docker守护进程启动时就已经停止了的容器</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> redis<span class="token punctuation">-</span>server /etc/redis/redis.conf <span class="token punctuation">-</span><span class="token punctuation">-</span>requirepass 123456clx <span class="token punctuation">-</span><span class="token punctuation">-</span>appendonly no <span class="token comment"># 启动redis服务并添加密码为：123456,默认不开启redis-aof方式持久化配置</span>
<span class="token comment">#    command: redis-server --requirepass 123456 --appendonly yes # 启动redis服务并添加密码为：123456,并开启redis持久化配置</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>                        <span class="token comment"># 设置环境变量,相当于docker run命令中的-e</span>
      <span class="token key atrule">TZ</span><span class="token punctuation">:</span> Asia/Shanghai
      <span class="token key atrule">LANG</span><span class="token punctuation">:</span> en_US.UTF<span class="token punctuation">-</span><span class="token number">8</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>                            <span class="token comment"># 数据卷挂载路径设置,将本机目录映射到容器目录</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;./redis/data:/data&quot;</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;./redis/config/redis.conf:/etc/redis/redis.conf&quot;</span>  <span class="token comment"># `redis.conf`文件内容`http://download.redis.io/redis-stable/redis.conf`</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>                              <span class="token comment"># 映射端口</span>
      <span class="token punctuation">-</span> <span class="token string">&quot;6382:6379&quot;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>启动</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">docker-compose</span> <span class="token parameter variable">-f</span> docker-compose-redis.yml <span class="token parameter variable">-p</span> redis up <span class="token parameter variable">-d</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>pom</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--SpringBoot通用依赖模块--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>

        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.commons<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-pool2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--swagger--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.xiaoymin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>knife4j-openapi3-jakarta-spring-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>4.4.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--通用基础配置boottest/lombok/hutool--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.hutool<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>hutool-all<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.8.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>


        <span class="token comment">&lt;!--redisson--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>redisson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.13.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div><p>yaml</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code>
<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9000</span>

<span class="token comment"># springdoc-openapi项目配置</span>
<span class="token key atrule">springdoc</span><span class="token punctuation">:</span>
  <span class="token key atrule">swagger-ui</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /swagger<span class="token punctuation">-</span>ui.html
    <span class="token key atrule">tags-sorter</span><span class="token punctuation">:</span> alpha
    <span class="token key atrule">operations-sorter</span><span class="token punctuation">:</span> alpha
  <span class="token key atrule">api-docs</span><span class="token punctuation">:</span>
    <span class="token key atrule">path</span><span class="token punctuation">:</span> /v3/api<span class="token punctuation">-</span>docs
  <span class="token key atrule">group-configs</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">group</span><span class="token punctuation">:</span> <span class="token string">'default'</span>
      <span class="token key atrule">paths-to-match</span><span class="token punctuation">:</span> <span class="token string">'/**'</span>
      <span class="token key atrule">packages-to-scan</span><span class="token punctuation">:</span> org.clxmm
<span class="token comment"># knife4j的增强配置，不需要增强可以不配</span>
<span class="token key atrule">knife4j</span><span class="token punctuation">:</span>
  <span class="token key atrule">enable</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">setting</span><span class="token punctuation">:</span>
    <span class="token key atrule">language</span><span class="token punctuation">:</span> zh_cn

<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">redis</span><span class="token punctuation">:</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">0</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> 123456clx
    <span class="token key atrule">timeout</span><span class="token punctuation">:</span> <span class="token number">300</span>
    <span class="token key atrule">mode</span><span class="token punctuation">:</span> single
    <span class="token key atrule">pool</span><span class="token punctuation">:</span>
      <span class="token key atrule">conn-timeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>
      <span class="token key atrule">so-timeout</span><span class="token punctuation">:</span> <span class="token number">3000</span>
      <span class="token key atrule">size</span><span class="token punctuation">:</span> <span class="token number">10</span>
    <span class="token key atrule">single</span><span class="token punctuation">:</span>
      <span class="token key atrule">address1</span><span class="token punctuation">:</span> 192.168.1.102<span class="token punctuation">:</span><span class="token number">6380</span>
      <span class="token key atrule">address2</span><span class="token punctuation">:</span> 192.168.1.102<span class="token punctuation">:</span><span class="token number">6381</span>
      <span class="token key atrule">address3</span><span class="token punctuation">:</span> 192.168.1.102<span class="token punctuation">:</span><span class="token number">6382</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><p>代码</p> <p>pro</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisPoolProperties</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> maxIdle<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> minIdle<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> maxActive<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> maxWait<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> connTimeout<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> soTimeout<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 池大小
     */</span>
    <span class="token keyword">private</span>  <span class="token keyword">int</span> size<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisSingleProperties</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span>  <span class="token class-name">String</span> address1<span class="token punctuation">;</span>
    <span class="token keyword">private</span>  <span class="token class-name">String</span> address2<span class="token punctuation">;</span>
    <span class="token keyword">private</span>  <span class="token class-name">String</span> address3<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.redis&quot;</span><span class="token punctuation">,</span> ignoreUnknownFields <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisProperties</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">int</span> database<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 等待节点回复命令的时间。该时间从命令发送成功时开始计时
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> timeout<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> password<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> mode<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 池配置
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisPoolProperties</span> pool<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 单机信息配置
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisSingleProperties</span> single<span class="token punctuation">;</span>


<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br></div></div><p>config</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableConfigurationProperties</span><span class="token punctuation">(</span><span class="token class-name">RedisProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CacheConfiguration</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RedisProperties</span> redisProperties<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> node <span class="token operator">=</span> redisProperties<span class="token punctuation">.</span><span class="token function">getSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;redis://&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> node <span class="token operator">:</span> <span class="token string">&quot;redis://&quot;</span> <span class="token operator">+</span> node<span class="token punctuation">;</span>
        <span class="token class-name">SingleServerConfig</span> serverConfig <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionPoolSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionMinimumIdleSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMinIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serverConfig<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> node <span class="token operator">=</span> redisProperties<span class="token punctuation">.</span><span class="token function">getSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;redis://&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> node <span class="token operator">:</span> <span class="token string">&quot;redis://&quot;</span> <span class="token operator">+</span> node<span class="token punctuation">;</span>
        <span class="token class-name">SingleServerConfig</span> serverConfig <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionPoolSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionMinimumIdleSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMinIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serverConfig<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RedissonClient</span> <span class="token function">redissonClient3</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Config</span> config <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Config</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> node <span class="token operator">=</span> redisProperties<span class="token punctuation">.</span><span class="token function">getSingle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAddress3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">&quot;redis://&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span> node <span class="token operator">:</span> <span class="token string">&quot;redis://&quot;</span> <span class="token operator">+</span> node<span class="token punctuation">;</span>
        <span class="token class-name">SingleServerConfig</span> serverConfig <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">useSingleServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setAddress</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getConnTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionPoolSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setConnectionMinimumIdleSize</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPool</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMinIdle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            serverConfig<span class="token punctuation">.</span><span class="token function">setPassword</span><span class="token punctuation">(</span>redisProperties<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Redisson</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>config<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 单机
     * @return
     */</span>
    <span class="token comment">/*@Bean
    public Redisson redisson()
    {
        Config config = new Config();

        config.useSingleServer().setAddress(&quot;redis://192.168.111.147:6379&quot;).setDatabase(0);

        return (Redisson) Redisson.create(config);
    }*/</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br></div></div><p>controller</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedLockController</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">CACHE_KEY_REDLOCK</span> <span class="token operator">=</span> <span class="token string">&quot;ATGUIGU_REDLOCK&quot;</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RedissonClient</span> redissonClient1<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RedissonClient</span> redissonClient2<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">RedissonClient</span> redissonClient3<span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> isLockBoolean<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;/multiLock&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getMultiLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">String</span> uuid <span class="token operator">=</span>  <span class="token class-name">IdUtil</span><span class="token punctuation">.</span><span class="token function">simpleUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> uuidValue <span class="token operator">=</span> uuid<span class="token operator">+</span><span class="token string">&quot;:&quot;</span><span class="token operator">+</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RLock</span> lock1 <span class="token operator">=</span> redissonClient1<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">CACHE_KEY_REDLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> lock2 <span class="token operator">=</span> redissonClient2<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">CACHE_KEY_REDLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RLock</span> lock3 <span class="token operator">=</span> redissonClient3<span class="token punctuation">.</span><span class="token function">getLock</span><span class="token punctuation">(</span><span class="token constant">CACHE_KEY_REDLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">RedissonMultiLock</span> redLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RedissonMultiLock</span><span class="token punctuation">(</span>lock1<span class="token punctuation">,</span> lock2<span class="token punctuation">,</span> lock3<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>uuidValue<span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;---come in biz multiLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">30</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span> e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>uuidValue<span class="token operator">+</span><span class="token string">&quot;\t&quot;</span><span class="token operator">+</span><span class="token string">&quot;---task is over multiLock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;multiLock exception &quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            redLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;释放分布式锁成功key:{}&quot;</span><span class="token punctuation">,</span> <span class="token constant">CACHE_KEY_REDLOCK</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token string">&quot;multiLock task is over  &quot;</span><span class="token operator">+</span>uuidValue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div><p>接口测试：http://localhost:9090/multilock</p> <p>命令：</p> <ul><li>ttl ATGUIGU_REDLOCK</li> <li>HGETALL ATGUIGU_REDLOCK</li> <li>shutdown</li></ul> <p>测试停止1台redis</p> <ul><li><p>docker stop redis-master-1</p></li> <li><p>docker start redis-master-1</p></li></ul> <h2 id="_5-redis缓存过期淘汰策略"><a href="#_5-redis缓存过期淘汰策略" class="header-anchor">#</a> 5.redis缓存过期淘汰策略</h2> <h3 id="_5-1-面试题"><a href="#_5-1-面试题" class="header-anchor">#</a> 5.1 面试题</h3> <ul><li>生产上你们的redis内存设置多少?</li> <li>如何配置、修改redis的内存大小</li> <li>如果内存满了你怎么办</li> <li>redis清理内存的方式？定期删除和惰性删除了解过吗</li> <li>redis缓存淘汰策略有哪些？分别是什么？你用那个？</li> <li>redis的LRU了解过吗？请手写LRU</li> <li>lru和lfu算法的区别是什么</li></ul> <h3 id="_5-2-redis内存设置"><a href="#_5-2-redis内存设置" class="header-anchor">#</a> 5.2 redis内存设置</h3> <p>redis默认内存多少？在哪里查看?如何设置修改?</p> <ul><li><p>查看Redis最大占用内存</p> <p>打开redis配置文件，设置maxmemory参数，maxmemory是bytes字节类型，注意转换。</p></li> <li><p>redis默认内存多少可以用？</p> <p>注意，在 64bit 系统下，maxmemory 设置为 0 表示不限制 Redis 内存使用</p></li> <li><p>一般生产上你如何配置？</p> <p>一般推荐Redis设置内存为最大物理内存的四分之三</p></li> <li><p>如何修改redis内存设置</p> <ul><li><p>通过配置文件</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>maxmemory 104865700
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>通过命令</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>config set  maxmemory 104865700
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li></ul></li> <li><p>什么命令查看redis内存使用情况?</p> <ul><li>info memory</li> <li>config get maxmemory</li></ul></li></ul> <p>真要打满了会怎么样？如果Redis内存使用超出了设置的最大值会怎样？</p> <ul><li><p>改改配置，故意把最大值设为1个byte试试</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411252052711.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411252053518.png" alt=""></p></li></ul> <p><strong>结论</strong></p> <p>设置了maxmemory的选项，假如redis内存使用达到上限，</p> <p>没有加上过期时间就会导致数据写满maxmemory为了避免类似情况，引出下一章内存淘汰策略</p> <h3 id="_5-3-redis的数据是如何删除的"><a href="#_5-3-redis的数据是如何删除的" class="header-anchor">#</a> 5.3 redis的数据是如何删除的</h3> <p>往redis里写的数据是怎么没了的?它如何删除的？</p> <ul><li><p>redis过期键的删除策略</p> <p>如果一个键是过期的，那它到了过期时间之后是不是马上就从内存中被被删除呢？？</p> <p>如果回答yes，立即删除，你自己走还是面试官送你走？</p> <p>如果不是，那过期后到底什么时候被删除呢？？是个什么操作？</p></li> <li><p>三种不同的删除策略</p> <ul><li><p>立即删除</p> <p>Redis不可能时时刻刻遍历所有被设置了生存时间的key，来检测数据是否已经到达过期时间，然后对它进行删除。</p> <p>立即删除能保证内存中数据的最大新鲜度，因为它保证过期键值会在过期后马上被删除，其所占用的内存也会随之释放。但是立即删除对cpu是最不友好的。因为删除操作会占用cpu的时间，如果刚好碰上了cpu很忙的时候，比如正在做交集或排序等计算的时候，就会给cpu造成额外的压力，让CPU心累，时时需要删除，忙死。。。。。。。</p> <p><strong>这会产生大量的性能消耗，同时也会影响数据的读取操作。</strong></p> <p>总结：对CPU不友好，用处理器性能换取存储空间 （拿时间换空间）</p></li> <li><p>惰性删除</p> <p>数据到达过期时间，不做处理。等下次访问该数据时，如果未过期，返回数据 ；发现已过期，删除，返回不存在。</p> <p>惰性删除策略的缺点是，它对内存是最不友好的。</p> <p>如果一个键已经过期，而这个键又仍然保留在redis中，那么只要这个过期键不被删除，它所占用的内存就不会释放。</p> <p>在使用惰性删除策略时，如果数据库中有非常多的过期键，而这些过期键又恰好没有被访问到的话，那么它们也许永远也不会被删除(除非用户手动执行FLUSHDB)，我们甚至可以将这种情况看作是一种内存泄漏–无用的垃圾数据占用了大量的内存，而服务器却不会自己去释放它们，这对于运行状态非常依赖于内存的Redis服务器来说,肯定不是一个好消息</p> <p>总结：对memory不友好，用存储空间换取处理器性能（拿空间换时间）</p> <p>开启憜性淘汰，lazyfree-lazy-eviction=yes</p></li> <li><p>定期删除</p> <ul><li>定期抽样key，判断是否过期</li> <li>漏网之鱼</li></ul> <p>定期删除策略是前两种策略的折中：定期删除策略每隔一段时间执行一次删除过期键操作并通过限制删除操作执行时长和频率来减少删除操作对CPU时间的影响。</p> <p>周期性轮询redis库中的时效性数据，采用随机抽取的策略，利用过期数据占比的方式控制删除频度</p> <p>特点1：CPU性能占用设置有峰值，检测频度可自定义设置</p> <p>特点2：内存压力不是很大，长期占用内存的冷数据会被持续清理</p> <p>总结：周期性抽查存储空间 （随机抽查，重点抽查）</p> <p>redis默认每隔100ms检查是否有过期的key，有过期key则删除。注意：redis不是每隔100ms将所有的key检查一次而是随机抽取进行检查(如果每隔100ms,全部key进行检查，redis直接进去ICU)。因此，如果只采用定期删除策略，会导致很多key到时间没有删除。</p> <p>定期删除策略的难点是确定删除操作执行的时长和频率：如果删除操作执行得太频繁或者执行的时间太长，定期删除策略就会退化成立即删除策略，以至于将CPU时间过多地消耗在删除过期键上面。如果删除操作执行得太少，或者执行的时间太短，定期删除策略又会和惰性删除束略一样，出现浪费内存的情况。因此，如果采用定期删除策略的话，服务器必须根据情况，合理地设置删除操作的执行时长和执行频率。</p></li></ul></li> <li><p>上述步骤都过堂了，还有漏洞吗?</p> <ul><li>1 定期删除时，从来没有被抽查到</li> <li>2 惰性删除时，也从来没有被点中使用过</li></ul> <p>上述两个步骤======&gt; 大量过期的key堆积在内存中，导致redis内存空间紧张或者很快耗尽</p> <p>必须要有一个更好的兜底方案......</p></li> <li><p>redis缓存淘汰策略登场。。。。。。O(∩_∩)O哈哈~</p></li></ul> <h3 id="_5-4-redis缓存淘汰策略"><a href="#_5-4-redis缓存淘汰策略" class="header-anchor">#</a> 5.4 redis缓存淘汰策略</h3> <ul><li><p>redis配置文件</p> <p>【MEMORY MANAGEMENT】</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411252147597.png" alt=""></p></li> <li><p>lru和lfu算法的区别是什么</p> <p><strong>区别</strong></p> <ul><li><p>LRU：最近最少使用页面置换算法，淘汰最长时间未被使用的页面，看页面最后一次被使用到发生调度的时间长短，首先淘汰最长时间未被使用的页面。</p></li> <li><p>LFU：最近最不常用页面置换算法，淘汰一定时期内被访问次数最少的页，看一定时间段内页面被使用的频率，淘汰一定时期内被访问次数最少的页</p></li> <li><p><strong>举个栗子</strong></p> <p>某次时期Time为10分钟,如果每分钟进行一次调页,主存块为3,若所需页面走向为2 1 2 1 2 3 4</p> <p>假设到页面4时会发生缺页中断</p> <p>若按LRU算法,应换页面1(1页面最久未被使用)，但按LFU算法应换页面3(十分钟内,页面3只使用了一次)</p> <p>可见LRU关键是看页面最后一次被使用到发生调度的时间长短,而LFU关键是看一定时间段内页面被使用的频率!</p></li></ul></li> <li><p>有哪些(redis7版本)</p> <ol><li>noeviction: 不会驱逐任何key，表示即使内存达到上限也不进行置换，所有能引起内存增加的命令都会返回error</li> <li>allkeys-lru: 对所有key使用LRU算法进行删除，优先删除掉最近最不经常使用的key，用以保存新数据</li> <li>volatile-lru: 对所有设置了过期时间的key使用LRU算法进行删除</li> <li>allkeys-random: 对所有key随机删除</li> <li>volatile-random: 对所有设置了过期时间的key随机删除</li> <li>volatile-ttl: 删除马上要过期的key</li> <li>allkeys-lfu: 对所有key使用LFU算法进行删除</li> <li>volatile-lfu: 对所有设置了过期时间的key使用LFU算法进行删除</li></ol></li> <li><p>上面总结</p> <ul><li>2 * 4 得8</li> <li>2个维度
<ul><li>过期键中筛选</li> <li>所有键中筛选</li></ul></li> <li>4个方面
<ul><li>LRU</li> <li>LFU</li> <li>random</li> <li>ttl</li></ul></li></ul></li></ul> <p>你平时用哪一种</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/09/redis202411252152478.png" alt=""></p> <p>如何配置、修改</p> <ul><li><p>直接用config命令</p></li> <li><p>直接redis.conf配置文件</p></li></ul> <p><strong>redis缓存淘汰策略配置性能建议</strong></p> <ul><li><p>避免存储bigkey</p></li> <li><p>开启憜性淘汰，lazyfree-lazy-eviction=yes</p></li></ul></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/clxmm/clxmm/edit/master/docs/01.后端学习/10.redis/17.Redlock算法.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=redis" title="标签">#redis</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/11/25, 22:00:11</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/6b15da/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">redis的分布式锁</div></a> <a href="/pages/086c39/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">18Redis源码</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/6b15da/" class="prev">redis的分布式锁</a></span> <span class="next"><a href="/pages/086c39/">18Redis源码</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/109f3c/"><div>
            vue学习
            <!----></div></a> <span class="date">12-21</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/7f2831/"><div>
            01vue学习
            <!----></div></a> <span class="date">11-27</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/086c39/"><div>
            18Redis源码
            <!----></div></a> <span class="date">11-26</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2024-2025
    <span>Evan Xu | <a href="https://github.com/clxmm" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ea6e1e7a.js" defer></script><script src="/assets/js/2.c9184447.js" defer></script><script src="/assets/js/3.b86c239d.js" defer></script><script src="/assets/js/27.b1757049.js" defer></script>
  </body>
</html>
