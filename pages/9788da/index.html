<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>06Redis哨兵(sentinel) | clxmm</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/icon.jpeg">
    <meta name="description" content="111">
    <meta name="keywords" content="clxmm">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.91c54501.css" as="style"><link rel="preload" href="/assets/js/app.5283cfe3.js" as="script"><link rel="preload" href="/assets/js/2.c9184447.js" as="script"><link rel="preload" href="/assets/js/3.b86c239d.js" as="script"><link rel="preload" href="/assets/js/16.b263764f.js" as="script"><link rel="prefetch" href="/assets/js/10.a39f7769.js"><link rel="prefetch" href="/assets/js/11.8c549dd5.js"><link rel="prefetch" href="/assets/js/12.dc299e70.js"><link rel="prefetch" href="/assets/js/13.7cc8e5e9.js"><link rel="prefetch" href="/assets/js/14.715b1c48.js"><link rel="prefetch" href="/assets/js/15.71d2dbc1.js"><link rel="prefetch" href="/assets/js/17.7201f4e6.js"><link rel="prefetch" href="/assets/js/18.94bf12e5.js"><link rel="prefetch" href="/assets/js/19.416a156a.js"><link rel="prefetch" href="/assets/js/20.33931d01.js"><link rel="prefetch" href="/assets/js/21.8e58e1f5.js"><link rel="prefetch" href="/assets/js/22.3d573a2c.js"><link rel="prefetch" href="/assets/js/23.bff780a4.js"><link rel="prefetch" href="/assets/js/24.98b533de.js"><link rel="prefetch" href="/assets/js/25.0bc0ae20.js"><link rel="prefetch" href="/assets/js/26.2c564d65.js"><link rel="prefetch" href="/assets/js/27.20eeab33.js"><link rel="prefetch" href="/assets/js/28.41ebbdfc.js"><link rel="prefetch" href="/assets/js/29.ff9dc3bd.js"><link rel="prefetch" href="/assets/js/30.b0ae8ed9.js"><link rel="prefetch" href="/assets/js/31.89127cdc.js"><link rel="prefetch" href="/assets/js/32.507cbd8f.js"><link rel="prefetch" href="/assets/js/33.8524fb76.js"><link rel="prefetch" href="/assets/js/34.98759eba.js"><link rel="prefetch" href="/assets/js/4.9f409e77.js"><link rel="prefetch" href="/assets/js/5.2e4cbb9e.js"><link rel="prefetch" href="/assets/js/6.7b582dbb.js"><link rel="prefetch" href="/assets/js/7.a74e574d.js"><link rel="prefetch" href="/assets/js/8.70da0217.js"><link rel="prefetch" href="/assets/js/9.dbd61e16.js">
    <link rel="stylesheet" href="/assets/css/0.styles.91c54501.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">clxmm</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/java/" class="nav-link">后端学习</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端学习" class="dropdown-title"><a href="/java/" class="link-title">后端学习</a> <span class="title" style="display:none;">后端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>01redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b54/" class="nav-link">01redis开始</a></li></ul></li><li class="dropdown-item"><h4>02redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b51/" class="nav-link">01redis开始</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/other/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>centos安装zsh</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/435ca7/" class="nav-link">centos安装zsh</a></li></ul></li></ul></div></div> <a href="https://github.com/clxmm/clxmm" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/java/" class="nav-link">后端学习</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端学习" class="dropdown-title"><a href="/java/" class="link-title">后端学习</a> <span class="title" style="display:none;">后端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>01redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b54/" class="nav-link">01redis开始</a></li></ul></li><li class="dropdown-item"><h4>02redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b51/" class="nav-link">01redis开始</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/other/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>centos安装zsh</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/435ca7/" class="nav-link">centos安装zsh</a></li></ul></li></ul></div></div> <a href="https://github.com/clxmm/clxmm" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>redis</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/356b54/" class="sidebar-link">01redis</a></li><li><a href="/pages/2a37ab/" class="sidebar-link">02redis持久化</a></li><li><a href="/pages/f01e54/" class="sidebar-link">03redis事务和管道</a></li><li><a href="/pages/75cece/" class="sidebar-link">04redis发布与订阅</a></li><li><a href="/pages/4a54cc/" class="sidebar-link">05Redis复制(replica)</a></li><li><a href="/pages/9788da/" aria-current="page" class="active sidebar-link">06Redis哨兵(sentinel)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/9788da/#_1-是什么" class="sidebar-link">1.是什么</a></li><li class="sidebar-sub-header level2"><a href="/pages/9788da/#_2-能干嘛" class="sidebar-link">2.能干嘛</a></li><li class="sidebar-sub-header level2"><a href="/pages/9788da/#_3-演示" class="sidebar-link">3.演示</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/9788da/#_3-1redis-sentinel架构-前提说明" class="sidebar-link">3.1Redis Sentinel架构，前提说明</a></li><li class="sidebar-sub-header level3"><a href="/pages/9788da/#_3-2-具体的步骤" class="sidebar-link">3.2 具体的步骤</a></li><li class="sidebar-sub-header level3"><a href="/pages/9788da/#_3-3-先启动一主二从3个redis实例-测试正常的主从复制" class="sidebar-link">3.3 先启动一主二从3个redis实例，测试正常的主从复制</a></li><li class="sidebar-sub-header level3"><a href="/pages/9788da/#_3-4-再启动3个哨兵-完成监控" class="sidebar-link">3.4 再启动3个哨兵，完成监控</a></li><li class="sidebar-sub-header level3"><a href="/pages/9788da/#_3-5-启动3个哨兵监控后再测试一次主从复制" class="sidebar-link">3.5 启动3个哨兵监控后再测试一次主从复制</a></li><li class="sidebar-sub-header level3"><a href="/pages/9788da/#_3-6-原有的master挂了" class="sidebar-link">3.6 原有的master挂了</a></li><li class="sidebar-sub-header level3"><a href="/pages/9788da/#_3-7-对比配置文件" class="sidebar-link">3.7 对比配置文件</a></li><li class="sidebar-sub-header level3"><a href="/pages/9788da/#_3-8-其它备注" class="sidebar-link">3.8 其它备注</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/9788da/#_4哨兵运行流程和选举原理" class="sidebar-link">4哨兵运行流程和选举原理</a></li><li class="sidebar-sub-header level2"><a href="/pages/9788da/#_5-哨兵使用建议" class="sidebar-link">5.哨兵使用建议</a></li></ul></li><li><a href="/pages/551b67/" class="sidebar-link">07Redis集群(cluster)</a></li><li><a href="/pages/ebe3c7/" class="sidebar-link">08redis与SpringBoot集成</a></li><li><a href="/pages/fa5943/" class="sidebar-link">redis单线程与多线程</a></li><li><a href="/pages/ec796f/" class="sidebar-link">redis的BigKey</a></li><li><a href="/pages/e53d85/" class="sidebar-link">redis缓存双写一致性</a></li><li><a href="/pages/a32a66/" class="sidebar-link">12redis与mysql双写一致性</a></li><li><a href="/pages/8249db/" class="sidebar-link">13案列bitmap-hyperlog-geo</a></li><li><a href="/pages/d7b34c/" class="sidebar-link">14布隆过滤器BloomFilter</a></li><li><a href="/pages/cdc2c8/" class="sidebar-link">缓存预热、雪崩、击穿、穿透</a></li><li><a href="/pages/6b15da/" class="sidebar-link">redis的分布式锁</a></li><li><a href="/pages/6be928/" class="sidebar-link">17Redlock算法</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>redis02</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/java/#后端学习" data-v-06970110>后端学习</a></li><li data-v-06970110><a href="/java/#redis" data-v-06970110>redis</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/clxmm" target="_blank" title="作者" class="beLink" data-v-06970110>clxmm</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2024-08-21</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><!---->06Redis哨兵(sentinel)<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="_1-是什么"><a href="#_1-是什么" class="header-anchor">#</a> 1.是什么</h2> <p>吹哨人巡查监控后台master主机是否故障，如果故障了根据<strong>投票数</strong>自动将某一个从库转换为新主库，继续对外服务</p> <p><strong>作用</strong></p> <p><a href="https://redis.io/docs/manual/sentinel/" target="_blank" rel="noopener noreferrer">官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ul><li>1、监控redis运行状态，包括master和slave</li> <li>2、当master down机，能自动将slave切换成新master</li></ul> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262114659.png" style="zoom:67%;"> <p>俗称，无人值守运维</p> <h2 id="_2-能干嘛"><a href="#_2-能干嘛" class="header-anchor">#</a> 2.能干嘛</h2> <ul><li>主从监控：监控主从redis库运行是否正常</li> <li>消息通知：哨兵可以将故障转移的结果发送给客户端</li> <li>故障转移：如果Master异常，则会进行主从切换，将其中一个Slave作为新Master</li> <li>配置中心：客户端通过连接哨兵来获得当前Redis服务的主节点地址</li></ul> <h2 id="_3-演示"><a href="#_3-演示" class="header-anchor">#</a> 3.演示</h2> <h3 id="_3-1redis-sentinel架构-前提说明"><a href="#_3-1redis-sentinel架构-前提说明" class="header-anchor">#</a> 3.1<strong>Redis Sentinel架构，前提说明</strong></h3> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262119710.png" style="zoom:67%;"> <ul><li>3个哨兵:自动监控和维护集群，不存放数据，只是吹哨人</li> <li>1主2从:用于数据读取和存放</li></ul> <h3 id="_3-2-具体的步骤"><a href="#_3-2-具体的步骤" class="header-anchor">#</a> 3.2 具体的步骤</h3> <ol><li><p><strong>/myredis目录下新建或者拷贝sentinel.conf文件，名字绝不能错</strong></p></li> <li><p>先看看/opt目录下默认的sentinel.conf文件的内容</p></li> <li><p>重点参数项说明</p> <ul><li><p>bind：服务监听地址，用于客户端连接，默认本机地址</p></li> <li><p>daemonize：是否以后台daemon方式运行</p></li> <li><p>protected-mode：安全保护模式</p></li> <li><p>port：</p></li> <li><p>logfile：</p></li> <li><p>pidfile：pid文件路径</p></li> <li><p>dir：工作目录</p></li> <li><p><code>sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</code></p></li> <li><p><code>sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</code></p></li> <li><p>其他：</p> <ul><li><p><code>sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</code>:指定多少毫秒之后，主节点没有应答哨兵，此时哨兵主观上认为主节点下线</p></li> <li><p><code>sentinel parallel-syncs &lt;master-name&gt; &lt;nums&gt;：</code> 表示允许并行同步的slave个数，当Master挂了后，哨兵会选出新的Master，此时，剩余的slave会向新的master发起同步数据</p></li> <li><p><code>sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</code>: 故障转移的超时时间，进行故障转移时，如果超过设置的毫秒，表示故障转移失败</p></li> <li><p><code>sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</code>: 配置当某一事件发生时所需要执行的脚本</p></li> <li><p><code>sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</code>: 客户端重新配置主节点参数脚本</p></li></ul></li></ul></li> <li><p>本次案例哨兵sentinel文件通用配置</p> <ol><li><p>由于机器硬件关系，我们的3个哨兵都同时配置进192.168.111.169同一台机器</p></li> <li><p>sentinel26379.conf</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
daemonize <span class="token function">yes</span>
protected-mode no
port <span class="token number">26379</span>
logfile <span class="token string">&quot;/myredis/sentinel26379.log&quot;</span>
pidfile /var/run/redis-sentinel26379.pid
<span class="token function">dir</span> /myredis
sentinel monitor mymaster <span class="token number">192.168</span>.111.169 <span class="token number">6379</span> <span class="token number">2</span>
sentinel auth-pass mymaster <span class="token number">111111</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>sentinel26380.conf</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
daemonize <span class="token function">yes</span>
protected-mode no
port <span class="token number">26380</span>
logfile <span class="token string">&quot;/myredis/sentinel26380.log&quot;</span>
pidfile /var/run/redis-sentinel26380.pid
<span class="token function">dir</span> <span class="token string">&quot;/myredis&quot;</span>
sentinel monitor mymaster <span class="token number">192.168</span>.111.169 <span class="token number">6379</span> <span class="token number">2</span>
sentinel auth-pass mymaster <span class="token number">111111</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li> <li><p>sentinel26381.conf</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
daemonize <span class="token function">yes</span>
protected-mode no
port <span class="token number">26381</span>
logfile <span class="token string">&quot;/myredis/sentinel26381.log&quot;</span>
pidfile /var/run/redis-sentinel26381.pid
<span class="token function">dir</span> <span class="token string">&quot;/myredis&quot;</span>
sentinel monitor mymaster <span class="token number">192.168</span>.111.169 <span class="token number">6379</span> <span class="token number">2</span>
sentinel auth-pass mymaster <span class="token number">111111</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ol></li></ol> <h3 id="_3-3-先启动一主二从3个redis实例-测试正常的主从复制"><a href="#_3-3-先启动一主二从3个redis实例-测试正常的主从复制" class="header-anchor">#</a> 3.3 先启动一主二从3个redis实例，测试正常的主从复制</h3> <p><strong>架构说明</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262135970.png" alt=""></p> <table><thead><tr><th>169机器上新建redis6379.conf配置文件，由于要配合本次案例，请设置masterauth项访问密码为111111，不然后续可能报错master_link_status:down</th></tr></thead> <tbody><tr><td>172机器上新建redis6380.conf配置文件，设置好replicaof<code>&lt;masterip&gt; &lt;masterport&gt;</code></td></tr> <tr><td>173机器上新建redis6381.conf配置文件，设置好replicaof<code>&lt;masterip&gt; &lt;masterport&gt;</code></td></tr></tbody></table> <p><strong>3台不同的虚拟机实例，启动三部真实机器实例并连接</strong></p> <p><code>redis-cli -a 111111 -p 6379</code></p> <h3 id="_3-4-再启动3个哨兵-完成监控"><a href="#_3-4-再启动3个哨兵-完成监控" class="header-anchor">#</a> 3.4 再启动3个哨兵，完成监控</h3> <ul><li><code>redis-sentinel sentinel26379.conf --sentinel</code></li> <li><code>redis-sentinel sentinel26380.conf --sentinel</code></li> <li><code>redis-sentinel sentinel26381.conf --sentinel</code></li></ul> <h3 id="_3-5-启动3个哨兵监控后再测试一次主从复制"><a href="#_3-5-启动3个哨兵监控后再测试一次主从复制" class="header-anchor">#</a> 3.5 启动3个哨兵监控后再测试一次主从复制</h3> <h3 id="_3-6-原有的master挂了"><a href="#_3-6-原有的master挂了" class="header-anchor">#</a> 3.6 原有的master挂了</h3> <ul><li><p>我们自己手动关闭6379服务器，模拟master挂了</p></li> <li><p>问题思考</p> <ul><li>两台<strong>从机</strong>数据是否OK</li> <li>是否会从剩下的2台机器上选出新的master</li> <li>之前down机的master机器重启回来，谁将会是新老大？会不会双master冲突？</li></ul></li> <li><p>答案</p> <ul><li><p>数据OK</p> <ul><li><p>两个小问题</p></li> <li><p>了解 Broken Pipe</p></li></ul> <table><thead><tr><th>认识broken pipe</th> <th>pipe是管道的意思，管道里面是数据流，通常是从文件或网络套接字读取的数据。当该管道从另一端突然关闭时，会发生数据突然中断，即是broken，对于socket来说，可能是网络被拔出或另一端的进程崩溃</th></tr></thead> <tbody><tr><td>解决问题</td> <td>其实当该异常产生的时候，对于服务端来说，并没有多少影响。因为可能是某个客户端突然中止了进程导致了该错误</td></tr> <tr><td>总结 Broken Pipe</td> <td>这个异常是客户端读取超时关闭了连接,这时候服务器端再向客户端已经断开的连接写数据时就发生了broken pipe异常！</td></tr></tbody></table></li> <li><p>投票新选</p> <ul><li><p>sentinel26379.log</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262145950.png" style="zoom:80%;"></li> <li><p>sentinel26380.log</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262145703.png" style="zoom:80%;"></li> <li><p>sentinel26381.log</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262146753.png" alt=""></p></li></ul></li> <li><p>谁是master，限本次案例</p> <ul><li><p>6381被选为新master，上位成功</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262148392.png" alt=""></p></li> <li><p>以前的6379从master降级变成了slave</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262148954.png" alt=""></p></li> <li><p>6380还是slave，只不过换了个新老大6381(6379变6381)，6380还是slave</p></li></ul></li></ul></li></ul> <h3 id="_3-7-对比配置文件"><a href="#_3-7-对比配置文件" class="header-anchor">#</a> 3.7 对比配置文件</h3> <ul><li>vim sentinel26379.conf</li> <li>老master，vim redis6379.conf</li> <li>新master，vim redis6381.conf</li></ul> <p><strong>结论</strong>⭐</p> <ul><li>文件的内容，在运行期间会被sentinel动态进行更改</li> <li><strong>Master-Slave切换后，master_redis.conf、slave_redis.conf和sentinel.conf的内容都会发生改变，即master_redis.conf中会多一行slaveof的配置，sentinel.conf的监控目标会随之调换</strong></li></ul> <h3 id="_3-8-其它备注"><a href="#_3-8-其它备注" class="header-anchor">#</a> 3.8 其它备注</h3> <ul><li>生产都是不同机房不同服务器，很少出现3个哨兵全挂掉的情况</li> <li>可以同时监控多个master，一行一个</li></ul> <h2 id="_4哨兵运行流程和选举原理"><a href="#_4哨兵运行流程和选举原理" class="header-anchor">#</a> 4哨兵运行流程和选举原理</h2> <p>当一个主从配置中的master失效之后，sentinel可以选举出一个新的master，用于自动接替原master的工作，主从配置中的其他redis服务器自动指向新的master同步数据。一般建议sentinel采取奇数台，防止某一台sentinel无法连接到master导致误切换</p> <p><strong>运行流程，故障切换</strong></p> <ul><li><p>三个哨兵监控一主二从，正常运行中......</p></li> <li><p>SDown主观下线(Subjectively Down)</p> <ul><li><p>SDOWN(主观不可用)是<strong>单个sentinel自己主观上</strong>检测到的关于master的状态，从sentinel的角度来看，如果发送了PING心跳后，在一定时间内没有收到合法的回复，就达到了SDOWN的条件。</p></li> <li><p>sentinel配置文件中的down-after-milliseconds设置了判断主观下线的时间长度</p></li> <li><p>说明</p> <p>所谓主观下线（Subjectively Down， 简称 SDOWN）指的是单个Sentinel实例对服务器做出的下线判断，即单个sentinel认为某个服务下线（有可能是接收不到订阅，之间的网络不通等等原因）。主观下线就是说如果服务器在[sentinel down-after-milliseconds]给定的毫秒数之内没有回应PING命令或者返回一个错误消息， 那么这个Sentinel会主观的(单方面的)认为这个master不可以用了，o(╥﹏╥)o</p> <p><code>sentinel down-after-milliseconds &lt;masterName&gt; &lt;timeout&gt;</code> : 表示master被当前sentinel实例认定为失效的间隔时间，这个配置其实就是进行主观下线的一个依据,master在多长时间内一直没有给Sentine返回有效信息，则认定该master主观下线。也就是说如果多久没联系上redis-servevr，认为这个redis-server进入到失效（SDOWN）状态。</p></li></ul></li> <li><p>ODown客观下线(Objectively Down)</p> <ul><li><p>ODOWN需要一定数量的sentinel，多个哨兵达成一致意见,才能认为一个master客观上已经宕掉</p></li> <li><p>四个参数含义：</p> <p><code>sentinel monitor mymaster 192.168.111.169 6379 2</code></p> <p>masterName是对某个master+slave组合的一个区分标识(一套sentinel可以监听多组master+slave这样的组合)</p> <p><strong>quorum这个参数是进行客观下线的一个依据</strong>，法定人数/法定票数,意思是至少有quorum个sentinel认为这个master有故障才会对这个master进行下线以及故障转移。因为有的时候，某个sentinel节点可能因为自身网络原因导致无法连接master，而此时master并没有出现故障，所以这就需要多个sentinel都一致认为该master有问题，才可以进行下一步操作，这就保证了公平性和高可用。</p></li></ul></li> <li><p>选举出领导者哨兵(哨兵中选出兵王)</p> <ul><li><p>当主节点被判断客观下线以后，各个哨兵节点会进行协商，先选举出一个<strong>领导者哨兵节点（兵王）</strong> 并由该领导者节点，也即被选举出的兵王进行failover（故障迁移）</p></li> <li><p>哨兵领导者，兵王如何选出来的？</p> <p>Raft算法</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-sentinel202408262201812.png" alt=""></p> <p>监视该主节点的所有哨兵都有可能被选为领导者，选举使用的算法是Raft算法；Raft算法的基本思路<strong>是先到先得</strong>即在一轮选举中，哨兵A向B发送成为领导者的申请，如果B没有同意过其他哨兵，则会同意A成为领导者</p></li></ul></li> <li><p>由兵王开始推动故障切换流程并选出一个新master</p> <ul><li>新主登基
<ul><li>某个Slave被选中成为新Master</li> <li>选出新master的规则，剩余slave节点健康前提下</li></ul></li> <li>群臣俯首
<ul><li>执行slaveof no one命令让选出来的从节点成为新的主节点，并通过slaveof命令让其他节点成为其从节点</li> <li>Sentinel leader会对选举出的新master执行slaveof no one操作，将其提升为master节点</li> <li>Sentinel leader向其它slave发送命令，让剩余的slave成为新的master节点的slave</li></ul></li> <li>旧主拜服
<ul><li>将之前已下线的老master设置为新选出的新master的从节点，当老master重新上线后，它会成为新master的从节点</li> <li>Sentinel leader会让原来的master降级为slave并恢复正常工作。</li></ul></li> <li>上述的failover操作均由sentinel自己独自完成，完全无需人工干预。</li></ul></li></ul> <h2 id="_5-哨兵使用建议"><a href="#_5-哨兵使用建议" class="header-anchor">#</a> 5.哨兵使用建议</h2> <ul><li>哨兵节点的数量应为多个，哨兵本身应该集群，保证高可用</li> <li>哨兵节点的数量应该是奇数</li> <li>各个哨兵节点的配置应一致</li> <li>如果哨兵节点部署在Docker等容器里面，尤其要注意端口的正确映射</li> <li>哨兵集群+主从复制，并不能保证数据零丢失---<strong>承上启下引出集群</strong></li></ul></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/clxmm/clxmm/edit/master/docs/01.后端学习/10.redis/06.redis哨兵.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=redis" title="标签">#redis</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/08/26, 22:22:02</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/4a54cc/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">05Redis复制(replica)</div></a> <a href="/pages/551b67/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">07Redis集群(cluster)</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/4a54cc/" class="prev">05Redis复制(replica)</a></span> <span class="next"><a href="/pages/551b67/">07Redis集群(cluster)</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/6be928/"><div>
            17Redlock算法
            <!----></div></a> <span class="date">11-12</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/6b15da/"><div>
            redis的分布式锁
            <!----></div></a> <span class="date">10-10</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/435ca7/"><div>
            centos安装zsh
            <!----></div></a> <span class="date">10-08</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2024-2024
    <span>Evan Xu | <a href="https://github.com/clxmm" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5283cfe3.js" defer></script><script src="/assets/js/2.c9184447.js" defer></script><script src="/assets/js/3.b86c239d.js" defer></script><script src="/assets/js/16.b263764f.js" defer></script>
  </body>
</html>
