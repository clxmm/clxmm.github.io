<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>07Redis集群(cluster) | clxmm</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/icon.jpeg">
    <meta name="description" content="111">
    <meta name="keywords" content="clxmm">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.91c54501.css" as="style"><link rel="preload" href="/assets/js/app.6504b631.js" as="script"><link rel="preload" href="/assets/js/2.c9184447.js" as="script"><link rel="preload" href="/assets/js/3.b86c239d.js" as="script"><link rel="preload" href="/assets/js/17.d2137085.js" as="script"><link rel="prefetch" href="/assets/js/10.3bb44866.js"><link rel="prefetch" href="/assets/js/11.0f140867.js"><link rel="prefetch" href="/assets/js/12.04b38893.js"><link rel="prefetch" href="/assets/js/13.607f8a97.js"><link rel="prefetch" href="/assets/js/14.bef8db98.js"><link rel="prefetch" href="/assets/js/15.262df607.js"><link rel="prefetch" href="/assets/js/16.349b5b9c.js"><link rel="prefetch" href="/assets/js/18.94bf12e5.js"><link rel="prefetch" href="/assets/js/19.416a156a.js"><link rel="prefetch" href="/assets/js/20.33931d01.js"><link rel="prefetch" href="/assets/js/21.8e58e1f5.js"><link rel="prefetch" href="/assets/js/22.e5a8bb91.js"><link rel="prefetch" href="/assets/js/23.b24b112f.js"><link rel="prefetch" href="/assets/js/24.c551d4f4.js"><link rel="prefetch" href="/assets/js/25.9329c667.js"><link rel="prefetch" href="/assets/js/26.501c23de.js"><link rel="prefetch" href="/assets/js/27.55be85e3.js"><link rel="prefetch" href="/assets/js/28.1cc196ce.js"><link rel="prefetch" href="/assets/js/29.86f67f48.js"><link rel="prefetch" href="/assets/js/30.c88df1af.js"><link rel="prefetch" href="/assets/js/31.0374d8b8.js"><link rel="prefetch" href="/assets/js/32.caf9bf23.js"><link rel="prefetch" href="/assets/js/33.c1da0085.js"><link rel="prefetch" href="/assets/js/34.5c6f7950.js"><link rel="prefetch" href="/assets/js/35.ef5833b8.js"><link rel="prefetch" href="/assets/js/36.e7ff57cf.js"><link rel="prefetch" href="/assets/js/37.52d5c60e.js"><link rel="prefetch" href="/assets/js/38.6d47519d.js"><link rel="prefetch" href="/assets/js/39.cd7bad59.js"><link rel="prefetch" href="/assets/js/4.0b47cc26.js"><link rel="prefetch" href="/assets/js/40.bd5cfa44.js"><link rel="prefetch" href="/assets/js/5.2e4cbb9e.js"><link rel="prefetch" href="/assets/js/6.7b582dbb.js"><link rel="prefetch" href="/assets/js/7.ac6d362f.js"><link rel="prefetch" href="/assets/js/8.e1180ebd.js"><link rel="prefetch" href="/assets/js/9.058f530e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.91c54501.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">clxmm</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端学习" class="dropdown-title"><a href="/java/" class="link-title">后端学习</a> <span class="title" style="display:none;">后端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>01redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b54/" class="nav-link">01redis开始</a></li></ul></li><li class="dropdown-item"><h4>02redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b51/" class="nav-link">01redis开始</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习" class="dropdown-title"><a href="/web/" class="link-title">前端学习</a> <span class="title" style="display:none;">前端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/7f2831/" class="nav-link">01vue学习</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/other/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>centos安装zsh</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/435ca7/" class="nav-link">centos安装zsh</a></li></ul></li></ul></div></div> <a href="https://github.com/clxmm/clxmm" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端学习" class="dropdown-title"><a href="/java/" class="link-title">后端学习</a> <span class="title" style="display:none;">后端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>01redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b54/" class="nav-link">01redis开始</a></li></ul></li><li class="dropdown-item"><h4>02redis学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/356b51/" class="nav-link">01redis开始</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端学习" class="dropdown-title"><a href="/web/" class="link-title">前端学习</a> <span class="title" style="display:none;">前端学习</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>vue2学习</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/7f2831/" class="nav-link">01vue学习</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其他" class="dropdown-title"><a href="/other/" class="link-title">其他</a> <span class="title" style="display:none;">其他</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>centos安装zsh</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/435ca7/" class="nav-link">centos安装zsh</a></li></ul></li></ul></div></div> <a href="https://github.com/clxmm/clxmm" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>redis</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/356b54/" class="sidebar-link">01redis</a></li><li><a href="/pages/2a37ab/" class="sidebar-link">02redis持久化</a></li><li><a href="/pages/f01e54/" class="sidebar-link">03redis事务和管道</a></li><li><a href="/pages/75cece/" class="sidebar-link">04redis发布与订阅</a></li><li><a href="/pages/4a54cc/" class="sidebar-link">05Redis复制(replica)</a></li><li><a href="/pages/9788da/" class="sidebar-link">06Redis哨兵(sentinel)</a></li><li><a href="/pages/551b67/" aria-current="page" class="active sidebar-link">07Redis集群(cluster)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/551b67/#_1-是什么" class="sidebar-link">1.是什么</a></li><li class="sidebar-sub-header level2"><a href="/pages/551b67/#_2-能干什么" class="sidebar-link">2.能干什么</a></li><li class="sidebar-sub-header level2"><a href="/pages/551b67/#_3-集群算法-分片-槽位slot" class="sidebar-link">3.集群算法-分片-槽位slot</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/551b67/#_3-1-redis集群的槽位slot" class="sidebar-link">3.1 redis集群的槽位slot</a></li><li class="sidebar-sub-header level3"><a href="/pages/551b67/#_3-2-redis集群的分片" class="sidebar-link">3.2 redis集群的分片</a></li><li class="sidebar-sub-header level3"><a href="/pages/551b67/#_3-3-他两的优势" class="sidebar-link">3.3 他两的优势</a></li><li class="sidebar-sub-header level3"><a href="/pages/551b67/#_3-4-slot槽位映射-一般业界有3种解决方案" class="sidebar-link">3.4 slot槽位映射，一般业界有3种解决方案</a></li><li class="sidebar-sub-header level4"><a href="/pages/551b67/#_3-4-1-哈希取余分区" class="sidebar-link">3.4.1 哈希取余分区</a></li><li class="sidebar-sub-header level4"><a href="/pages/551b67/#_3-4-2-一致性哈希算法分区" class="sidebar-link">3.4.2 一致性哈希算法分区</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/551b67/#" class="sidebar-link"></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level4"><a href="/pages/551b67/#_3-4-3-哈希槽分区⭐" class="sidebar-link">3.4.3 哈希槽分区⭐</a></li><li class="sidebar-sub-header level5"><a href="/pages/551b67/#_1-是什么-2" class="sidebar-link">1. 是什么</a></li><li class="sidebar-sub-header level5"><a href="/pages/551b67/#_2-哈希槽计算" class="sidebar-link">2. 哈希槽计算</a></li><li class="sidebar-sub-header level5"><a href="/pages/551b67/#_3-集群的最大槽数是16384-⭐" class="sidebar-link">3.集群的最大槽数是16384 ⭐</a></li><li class="sidebar-sub-header level5"><a href="/pages/551b67/#_4-redis集群不保证强一致性-这意味着在特定的条件下-redis集群可能会丢掉一些被系统收到的写入请求命令" class="sidebar-link">4.Redis集群不保证强一致性，这意味着在特定的条件下，Redis集群可能会丢掉一些被系统收到的写入请求命令</a></li><li class="sidebar-sub-header level3"><a href="/pages/551b67/#_3-5-集群环境搭建⭐" class="sidebar-link">3.5 集群环境搭建⭐</a></li><li class="sidebar-sub-header level4"><a href="/pages/551b67/#_3-5-1-3主3从redis集群配置" class="sidebar-link">3.5.1 3主3从redis集群配置</a></li><li class="sidebar-sub-header level4"><a href="/pages/551b67/#_3-5-2-3主3从redis集群读写" class="sidebar-link">3.5.2 3主3从redis集群读写</a></li><li class="sidebar-sub-header level4"><a href="/pages/551b67/#_3-5-3主从容错切换迁移案例" class="sidebar-link">3.5.3主从容错切换迁移案例</a></li><li class="sidebar-sub-header level4"><a href="/pages/551b67/#_3-5-4-主从扩容案例" class="sidebar-link">3.5.4 主从扩容案例</a></li><li class="sidebar-sub-header level4"><a href="/pages/551b67/#_3-5-5-主从缩容案例" class="sidebar-link">3.5.5 主从缩容案例</a></li><li class="sidebar-sub-header level3"><a href="/pages/551b67/#_3-6-集群常用操作命令和crc16算法分析" class="sidebar-link">3.6 集群常用操作命令和CRC16算法分析</a></li></ul></li></ul></li><li><a href="/pages/ebe3c7/" class="sidebar-link">08redis与SpringBoot集成</a></li><li><a href="/pages/fa5943/" class="sidebar-link">redis单线程与多线程</a></li><li><a href="/pages/ec796f/" class="sidebar-link">redis的BigKey</a></li><li><a href="/pages/e53d85/" class="sidebar-link">redis缓存双写一致性</a></li><li><a href="/pages/a32a66/" class="sidebar-link">12redis与mysql双写一致性</a></li><li><a href="/pages/8249db/" class="sidebar-link">13案列bitmap-hyperlog-geo</a></li><li><a href="/pages/d7b34c/" class="sidebar-link">14布隆过滤器BloomFilter</a></li><li><a href="/pages/cdc2c8/" class="sidebar-link">缓存预热、雪崩、击穿、穿透</a></li><li><a href="/pages/6b15da/" class="sidebar-link">redis的分布式锁</a></li><li><a href="/pages/6be928/" class="sidebar-link">17Redlock算法和缓存淘汰</a></li><li><a href="/pages/086c39/" class="sidebar-link">18Redis源码</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>redis02</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06970110><div class="articleInfo" data-v-06970110><ul class="breadcrumbs" data-v-06970110><li data-v-06970110><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06970110></a></li> <li data-v-06970110><a href="/java/#后端学习" data-v-06970110>后端学习</a></li><li data-v-06970110><a href="/java/#redis" data-v-06970110>redis</a></li></ul> <div class="info" data-v-06970110><div title="作者" class="author iconfont icon-touxiang" data-v-06970110><a href="https://github.com/clxmm" target="_blank" title="作者" class="beLink" data-v-06970110>clxmm</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06970110><a href="javascript:;" data-v-06970110>2024-08-26</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><!---->07Redis集群(cluster)<!----></h1> <!----> <div class="theme-vdoing-content content__default"><h2 id="_1-是什么"><a href="#_1-是什么" class="header-anchor">#</a> 1.是什么</h2> <p><strong>定义</strong></p> <p><strong>由于数据量过大</strong>，单个Master复制集难以承担，因此需要对多个复制集进行集群，形成水平扩展每个复制集只负责存储整个数据集的一部分，这就是Redis的集群，其作用是提供在多个Redis节点间共享数据的程序集。</p> <p><a href="https://redis.io/docs/reference/cluster-spec/" target="_blank" rel="noopener noreferrer">官网<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272150294.png" style="zoom:67%;"> <ul><li>Redis集群是一个提供在多个Redis节点间共享数据的程序集</li> <li><strong>Redis集群可以支持多个Master</strong></li></ul> <h2 id="_2-能干什么"><a href="#_2-能干什么" class="header-anchor">#</a> 2.能干什么</h2> <ul><li>Redis集群支持多个Master，每个Master又可以挂载多个Slave</li> <li>由于Cluster自带Sentinel的故障转移机制，内置了高可用的支持，<strong>无需再去使用哨兵功能</strong></li> <li>客户端与Redis的节点连接，不再需要连接集群中所有的节点，只需要任意连接集群中的一个可用节点即可</li> <li><strong>槽位slot</strong>负责分配到各个物理服务节点，由对应的集群来负责维护节点、插槽和数据之间的关系</li></ul> <h2 id="_3-集群算法-分片-槽位slot"><a href="#_3-集群算法-分片-槽位slot" class="header-anchor">#</a> 3.集群算法-分片-槽位slot</h2> <p><a href="https://redis.io/docs/latest/operate/oss_and_stack/reference/cluster-spec/" target="_blank" rel="noopener noreferrer">Redis cluster specification | Docs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272156293.png" style="zoom:67%;"> <h3 id="_3-1-redis集群的槽位slot"><a href="#_3-1-redis集群的槽位slot" class="header-anchor">#</a> 3.1 redis集群的槽位slot</h3> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272157307.png" alt=""></p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272158566.png" style="zoom:67%;"> <h3 id="_3-2-redis集群的分片"><a href="#_3-2-redis集群的分片" class="header-anchor">#</a> 3.2 redis集群的分片</h3> <table><thead><tr><th>分片是什么</th> <th>使用Redis集群时我们会将存储的数据分散到多台redis机器上，这称为分片。简言之，集群中的每个Redis实例都被认为是整个数据的一个分片。</th></tr></thead> <tbody><tr><td>如何找到给定key的分片</td> <td>为了找到给定key的分片，我们对key进行CRC16(key)算法处理并通过对总分片数量取模。然后，使用确定性哈希函数，这意味着给定的key将多次始终映射到同一个分片，我们可以推断将来读取特定key的位置。</td></tr></tbody></table> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272158566.png" style="zoom:67%;"> <h3 id="_3-3-他两的优势"><a href="#_3-3-他两的优势" class="header-anchor">#</a> 3.3 他两的优势</h3> <p><strong>最大优势，方便扩缩容和数据分派查找</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272201206.png" alt=""></p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272158566.png" style="zoom:67%;"> <h3 id="_3-4-slot槽位映射-一般业界有3种解决方案"><a href="#_3-4-slot槽位映射-一般业界有3种解决方案" class="header-anchor">#</a> 3.4 slot槽位映射，一般业界有3种解决方案</h3> <h4 id="_3-4-1-哈希取余分区"><a href="#_3-4-1-哈希取余分区" class="header-anchor">#</a> 3.4.1 哈希取余分区</h4> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272203799.png" style="zoom:67%;"> <ul><li>2亿条记录就是2亿个k,v，我们单机不行必须要分布式多机，假设有3台机器构成一个集群，用户每次读写操作都是根据公式：<code>hash(key) % N个机器台数，计算出哈希值，用来决定数据映射到哪一个节点上。</code></li> <li>优点:   简单粗暴，直接有效，只需要预估好数据规划好节点，例如3台、8台、10台，就能保证一段时间的数据支撑。使用Hash算法让固定的一部分请求落到同一台服务器上，这样每台服务器固定处理一部分请求（并维护这些请求的信息），起到负载均衡+分而治之的作用。</li> <li>缺点：
<ul><li>原来规划好的节点，进行扩容或者缩容就比较麻烦了额，不管扩缩，每次数据变动导致节点有变动，映射关系需要重新进行计算，在服务器个数固定不变时没有问题，如果需要弹性扩容或故障停机的情况下，原来的取模公式就会发生变化：Hash(key)/3会变成Hash(key) /?。此时地址经过取余运算的结果将发生很大变化，根据公式获取的服务器也会变得不可控。某个redis机器宕机了，</li> <li>由于台数数量变化，会导致hash取余全部数据重新洗牌。</li></ul></li></ul> <h4 id="_3-4-2-一致性哈希算法分区"><a href="#_3-4-2-一致性哈希算法分区" class="header-anchor">#</a> 3.4.2 一致性哈希算法分区</h4> <ul><li><p>是什么：</p> <p>一致性Hash算法背景：　　一致性哈希算法在1997年由麻省理工学院中提出的，设计目标是为了解决</p> <p><strong>分布式缓存数据变动和映射问题，某个机器宕机了，分母数量改变了，自然取余数不OK了。</strong></p></li> <li><p>能干什么：</p> <ul><li>提出一致性Hash解决方案。</li> <li>目的是当服务器个数发生变动时，</li> <li>尽量减少影响客户端到服务器的映射关系</li></ul></li> <li><p>3大步骤⭐</p> <ul><li><p>算法构建一致性哈希环</p> <ul><li><p>一致性哈希环。</p></li> <li><p>一致性哈希算法必然有个hash函数并按照算法产生hash值，这个算法的所有可能哈希值会构成一个全量集，这个集合可以成为一个hash空间[0,2^32-1]，这个是一个线性空间，但是在算法中，我们通过适当的逻辑控制将它首尾相连(0 = 2^32),这样让它逻辑上形成了一个环形空间。</p></li> <li><p>它也是按照使用取模的方法，前面笔记介绍的节点取模法是对节点（服务器）的数量进行取模。而一致性Hash算法是对2^32取模，简单来说，一致性Hash算法将整个哈希值空间组织成一个虚拟的圆环，如假设某哈希函数H的值空间为0-2^32-1（即哈希值是一个32位无符号整形），整个哈希环如下图：整个空间按顺时针方向组织，圆环的正上方的点代表0，0点右侧的第一个点代表1，以此类推，2、3、4、……直到2^32-1，也就是说0点左侧的第一个点代表2^32-1， 0和2^32-1在零点中方向重合，我们把这个由2^32个点组成的圆环称为Hash环。</p></li></ul></li> <li><p>redis服务器IP节点映射</p> <ul><li><p>将集群中各个IP节点映射到环上的某一个位置。</p></li> <li><p>将各个服务器使用Hash进行一个哈希，具体可以选择服务器的IP或主机名作为关键字进行哈希，这样每台机器就能确定其在哈希环上的位置。假如4个节点NodeA、B、C、D，经过IP地址的哈希函数计算(hash(ip))，使用IP地址哈希后在环空间的位置如下：</p></li></ul> <h2 id=""><a href="#" class="header-anchor">#</a></h2></li> <li><p>key落到服务器的落键规则</p> <ul><li>当我们需要存储一个kv键值对时，首先计算key的hash值，hash(key)，将这个key使用相同的函数Hash计算出哈希值并确定此数据在环上的位置，<strong>从此位置沿环顺时针“行走”</strong>，第一台遇到的服务器就是其应该定位到的服务器，并将该键值对存储在该节点上。</li> <li>如我们有Object A、Object B、Object C、Object D四个数据对象，经过哈希计算后，在环空间上的位置如下：根据一致性Hash算法，数据A会被定为到Node A上，B被定为到Node B上，C被定为到Node C上，D被定为到Node D上。</li></ul></li></ul></li></ul> <h4 id="_3-4-3-哈希槽分区⭐"><a href="#_3-4-3-哈希槽分区⭐" class="header-anchor">#</a> 3.4.3 哈希槽分区⭐</h4> <h5 id="_1-是什么-2"><a href="#_1-是什么-2" class="header-anchor">#</a> 1. 是什么</h5> <p><strong>HASH_SLOT = CRC16(key) mod 16384</strong></p> <ul><li>1 为什么出现</li></ul> <p>哈希槽实质就是一个数组，数组[0,2^14 -1]形成hash slot空间。</p> <ul><li>2 能干什么</li></ul> <p>解决均匀分配的问题，在数据和节点之间又加入了一层，把这层称为哈希槽（slot），用于管理数据和节点之间的关系，现在就相当于节点上放的是槽，槽里放的是数据。</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272222966.png" alt=""></p> <p>槽解决的是粒度问题，相当于把粒度变大了，这样便于数据移动。哈希解决的是映射问题，使用key的哈希值来计算所在的槽，便于数据分配</p> <ul><li>3 多少个hash槽</li></ul> <p>一个集群只能有16384个槽，编号0-16383（0-2^14-1）。这些槽会分配给集群中的所有主节点，分配策略没有要求。</p> <p>集群会记录节点和槽的对应关系，解决了节点和槽的关系后，接下来就需要对key求哈希值，然后对16384取模，余数是几key就落入对应的槽里。HASH_SLOT = CRC16(key) mod 16384。以槽为单位移动数据，因为槽的数目是固定的，处理起来比较容易，这样数据移动问题就解决了。</p> <h5 id="_2-哈希槽计算"><a href="#_2-哈希槽计算" class="header-anchor">#</a> 2. 哈希槽计算</h5> <p>Redis 集群中内置了 16384 个哈希槽，redis 会根据节点数量大致均等的将哈希槽映射到不同的节点。当需要在 Redis 集群中放置一个 key-value时，redis先对key使用crc16算法算出一个结果然后用结果对16384求余数[ CRC16(key) % 16384]，这样每个 key 都会对应一个编号在 0-16383 之间的哈希槽，也就是映射到某个节点上。如下代码，key之A 、B在Node2， key之C落在Node3上</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272158566.png" style="zoom:67%;"> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408272225025.png" alt=""></p> <h5 id="_3-集群的最大槽数是16384-⭐"><a href="#_3-集群的最大槽数是16384-⭐" class="header-anchor">#</a> 3.集群的最大槽数是16384 ⭐</h5> <ul><li><p>为什么redis集群的最大槽数是16384个？</p> <p>Redis集群并没有使用一致性hash而是引入了哈希槽的概念。Redis 集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置哪个槽，集群的每个节点负责一部分hash槽。但为什么哈希槽的数量是16384（2^14）个呢？</p> <p>CRC16算法产生的hash值有16bit，该算法可以产生2^16=65536个值。换句话说值是分布在0~65535之间，有更大的65536不用为什么只用16384就够？作者在做mod运算的时候，为什么不mod65536，而选择mod16384？ HASH_SLOT = CRC16(key) mod 65536为什么没启用</p> <p>https://github.com/redis/redis/issues/2576</p></li> <li><p>说明1：正常的心跳数据包带有节点的完整配置，可以用幂等方式用旧的节点替换旧节点，以便更新旧的配置。这意味着它们包含原始节点的插槽配置，该节点使用2k的空间和16k的插槽，但是会使用8k的空间（使用65k的插槽）。同时，由于其他设计折衷，Redis集群不太可能扩展到1000个以上的主节点。因此16k处于正确的范围内，以确保每个主机具有足够的插槽，最多可容纳1000个矩阵，但数量足够少，可以轻松地将插槽配置作为原始位图传播。请注意，在小型群集中，位图将难以压缩，因为当N较小时，位图将设置的slot / N位占设置位的很大百分比。</p></li> <li><p>说明2：</p> <ul><li>(1)如果槽位为65536，发送心跳信息的消息头达8k，发送的心跳包过于庞大。在消息头中最占空间的是myslots[CLUSTER_SLOTS/8]。 当槽位为65536时，这块的大小是: 65536÷8÷1024=8kb。在消息头中最占空间的是myslots[CLUSTER_SLOTS/8]。 当槽位为16384时，这块的大小是: 16384÷8÷1024=2kb ，因为每秒钟，redis节点需要发送一定数量的ping消息作为心跳包，如果槽位为65536，这个ping消息的消息头太大了，浪费带宽。</li> <li>(2)redis的集群主节点数量基本不可能超过1000个。集群节点越多，心跳包的消息体内携带的数据越多。如果节点过1000个，也会导致网络拥堵。因此redis作者不建议redis cluster节点数量超过1000个。 那么，对于节点数在1000以内的redis cluster集群，16384个槽位够用了。没有必要拓展到65536个。</li> <li>(3)槽位越小，节点少的情况下，压缩比高，容易传输</li> <li>Redis主节点的配置信息中它所负责的哈希槽是通过一张bitmap的形式来保存的，在传输过程中会对bitmap进行压缩，但是如果bitmap的填充率slots / N很高的话(N表示节点数)，bitmap的压缩率就很低。 如果节点数很少，而哈希槽数量很多的话，bitmap的压缩率就很低。</li></ul></li></ul> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408282236584.png" alt=""></p> <h5 id="_4-redis集群不保证强一致性-这意味着在特定的条件下-redis集群可能会丢掉一些被系统收到的写入请求命令"><a href="#_4-redis集群不保证强一致性-这意味着在特定的条件下-redis集群可能会丢掉一些被系统收到的写入请求命令" class="header-anchor">#</a> 4.<strong>Redis集群</strong>不保证强一致性，这意味着在特定的条件下，Redis集群可能会丢掉一些被系统收到的写入请求命令</h5> <h3 id="_3-5-集群环境搭建⭐"><a href="#_3-5-集群环境搭建⭐" class="header-anchor">#</a> 3.5 集群环境搭建⭐</h3> <h4 id="_3-5-1-3主3从redis集群配置"><a href="#_3-5-1-3主3从redis集群配置" class="header-anchor">#</a> 3.5.1 3主3从redis集群配置</h4> <p><strong>找3台真实虚拟机，各自新建</strong></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">mkdir</span> <span class="token parameter variable">-p</span> /myredis/cluster
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>新建6个独立的redis实例服务</strong></p> <ul><li><p>本次案例设计说明(ip会有变化)</p></li> <li><p><code>IP：192.168.111.175+端口6381/端口6382</code></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span>  /myredis/cluster/redisCluster6381.conf
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
daemonize <span class="token function">yes</span>
protected-mode no
port <span class="token number">6381</span>
logfile <span class="token string">&quot;/myredis/cluster/cluster6381.log&quot;</span>
pidfile /myredis/cluster6381.pid
<span class="token function">dir</span> /myredis/cluster
dbfilename dump6381.rdb
appendonly <span class="token function">yes</span>
appendfilename <span class="token string">&quot;appendonly6381.aof&quot;</span>
requirepass <span class="token number">111111</span>
masterauth <span class="token number">111111</span>
 
<span class="token comment"># 集群配置</span>
cluster-enabled <span class="token function">yes</span>
cluster-config-file nodes-6381.conf
cluster-node-timeout <span class="token number">5000</span>

<span class="token function">vim</span>  /myredis/cluster/redisCluster6382.conf


<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
daemonize <span class="token function">yes</span>
protected-mode no
port <span class="token number">6382</span>
logfile <span class="token string">&quot;/myredis/cluster/cluster6382.log&quot;</span>
pidfile /myredis/cluster6382.pid
<span class="token function">dir</span> /myredis/cluster
dbfilename dump6382.rdb
appendonly <span class="token function">yes</span>
appendfilename <span class="token string">&quot;appendonly6382.aof&quot;</span>
requirepass <span class="token number">111111</span>
masterauth <span class="token number">111111</span>
 
cluster-enabled <span class="token function">yes</span>
cluster-config-file nodes-6382.conf
cluster-node-timeout <span class="token number">5000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div></li> <li><p><code>IP：192.168.111.172+端口6383/端口6384</code></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span>  /myredis/cluster/redisCluster6383.conf

<span class="token function">vim</span>  /myredis/cluster/redisCluster6384.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p><code>IP：192.168.111.174+端口6385/端口6386</code></p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span>  /myredis/cluster/redisCluster6385.conf

<span class="token function">vim</span>  /myredis/cluster/redisCluster6386.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>启动6台redis主机实例</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>redis-server /myredis/cluster/redisCluster6381.conf
<span class="token punctuation">..</span>.
redis-server /myredis/cluster/redisCluster6386.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li></ul> <p><strong>通过redis-cli命令为6台机器构建集群关系</strong></p> <p><strong>构建主从关系命令</strong>⭐</p> <ul><li><p>//注意，注意，注意自己的真实IP地址   //注意，注意，注意自己的真实IP地址</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>redis-cli <span class="token parameter variable">-a</span> <span class="token number">111111</span> <span class="token parameter variable">--cluster</span> create --cluster-replicas <span class="token number">1</span> <span class="token number">192.168</span>.111.175:6381 <span class="token number">192.168</span>.111.175:6382 <span class="token number">192.168</span>.111.172:6383 <span class="token number">192.168</span>.111.172:6384 <span class="token number">192.168</span>.111.174:6385 <span class="token number">192.168</span>.111.174:6386
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>--cluster-replicas 1 表示为每个master创建一个slave节点</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cli202408302132760.png" alt=""></p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302131499.png" style="zoom:67%;"></li></ul> <p><strong>链接进入6381作为切入点，查看并检验集群状态</strong></p> <ul><li><p>链接进入6381作为切入点，查看节点状态</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302135207.png" style="zoom:80%;"> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302136336.png" alt=""></p></li> <li><p>info replication</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302137374.png" style="zoom:50%;"></li> <li><p>cluster info</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis202408302138346.png" style="zoom:50%;"></li> <li><p>cluster nodes</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302139544.png" style="zoom:67%;"></li></ul> <h4 id="_3-5-2-3主3从redis集群读写"><a href="#_3-5-2-3主3从redis集群读写" class="header-anchor">#</a> 3.5.2 3主3从redis集群读写</h4> <ul><li><p>对6381新增两个key，看看效果如何</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302152773.png" alt=""></p></li> <li><p>为什么报错</p> <p>一定注意槽位的范围区间，需要路由到位，路由到位，路由到位，路由到位。</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408302157829.png" alt=""></p></li> <li><p>如何解决</p> <p><strong>加入参数-c，优化路由</strong></p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/202408302200299.png" alt=""></p></li> <li><p>查看集群信息</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/202408302201524.png" alt=""></p></li> <li><p>查看某个key该属于对应的槽位值，CLUSTER KEYSLOT 键名称</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/202408302202046.png" alt=""></p></li></ul> <h4 id="_3-5-3主从容错切换迁移案例"><a href="#_3-5-3主从容错切换迁移案例" class="header-anchor">#</a> 3.5.3主从容错切换迁移案例</h4> <ul><li><p>容错切换迁移</p> <ul><li><p>主6381和从机切换，先停止主机6381</p> <ul><li>6381主机停了，对应的真实从机上位</li> <li>6381作为1号主机分配的从机以实际情况为准，具体是几号机器就是几号</li></ul></li> <li><p>再次查看集群信息,本次6381主6384从</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312106753.png" alt=""></p> <p>6381master假如宕机了，6384是否会上位成为了新的master?</p></li> <li><p>停止主机6381,再次查看集群信息</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/202408312109447.png" alt=""></p> <p>6381宕机了，6384上位成为了新的master。</p> <p>备注：本次脑图笔记6381为主下面挂从6384。每次案例下面挂的从机以实际情况为准，具体是几号机器就是几号</p></li> <li><p>随后，6381原来的主机回来了，是否会上位？</p> <ul><li><p>恢复前</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312113943.png" alt=""></p></li> <li><p>恢复后</p> <p>6381不会上位并以从节点形式回归</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312113151.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312114936.png" alt=""></p></li></ul></li></ul></li> <li><p>集群不保证数据一致性100%OK，一定会有数据丢失情况，</p> <ul><li>Redis集群不保证强一致性，这意味着在特定的条件下，Redis集群可能会丢掉一些被系统收到的写入请求命令</li></ul></li> <li><p>手动故障转移 or 节点从属调整该如何处理</p> <ul><li><p>上面一换后6381、6384主从对调了，和原始设计图不一样了，该如何</p></li> <li><p>重新登陆6381机器</p></li> <li><p>常用命令</p> <ul><li><p>CLUSTER FAILOVER</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster.png" alt=""></p></li></ul></li></ul></li></ul> <h4 id="_3-5-4-主从扩容案例"><a href="#_3-5-4-主从扩容案例" class="header-anchor">#</a> 3.5.4 主从扩容案例</h4> <ul><li><p>新建6387、6388两个服务实例配置文件+新建后启动</p> <ul><li><p>IP：192.168.111.174+端口6387/端口6388</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code><span class="token function">vim</span>  /myredis/cluster/redisCluster6387.conf
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
daemonize <span class="token function">yes</span>
protected-mode no
port <span class="token number">6387</span>
logfile <span class="token string">&quot;/myredis/cluster/cluster6387.log&quot;</span>
pidfile /myredis/cluster6387.pid
<span class="token function">dir</span> /myredis/cluster
dbfilename dump6387.rdb
appendonly <span class="token function">yes</span>
appendfilename <span class="token string">&quot;appendonly6387.aof&quot;</span>
requirepass <span class="token number">111111</span>
masterauth <span class="token number">111111</span>

cluster-enabled <span class="token function">yes</span>
cluster-config-file nodes-6387.conf
cluster-node-timeout <span class="token number">5000</span>

<span class="token function">vim</span>  /myredis/cluster/redisCluster6388.conf
<span class="token builtin class-name">bind</span> <span class="token number">0.0</span>.0.0
daemonize <span class="token function">yes</span>
protected-mode no
port <span class="token number">6388</span>
logfile <span class="token string">&quot;/myredis/cluster/cluster6388.log&quot;</span>
pidfile /myredis/cluster6388.pid
<span class="token function">dir</span> /myredis/cluster
dbfilename dump6388.rdb
appendonly <span class="token function">yes</span>
appendfilename <span class="token string">&quot;appendonly6388.aof&quot;</span>
requirepass <span class="token number">111111</span>
masterauth <span class="token number">111111</span>
 
cluster-enabled <span class="token function">yes</span>
cluster-config-file nodes-6388.conf
cluster-node-timeout <span class="token number">5000</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div></li></ul></li> <li><p>启动87/88两个新的节点实例，此时他们自己都是master</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>redis-server /myredis/cluster/redisCluster6387.conf
redis-server /myredis/cluster/redisCluster6388.conf
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/202408312136733.png" alt=""></p></li> <li><p>将新增的6387节点(空槽号)作为master节点加入原集群</p> <ul><li><p>将新增的6387作为master节点加入原有集群</p></li> <li><p>redis-cli -a 密码 --cluster add-node 自己实际IP地址:6387 自己实际IP地址:6381</p></li> <li><p>6387 就是将要作为master新增节点</p></li> <li><p>6381 就是原来集群节点里面的领路人，相当于6387拜拜6381的码头从而找到组织加入集群</p></li> <li><p>redis-cli -a 111111 --cluster add-node 192.168.111.174:6387 192.168.111.175:6381</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312138740.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312138358.png" alt=""></p></li> <li><p>检查集群情况第1次</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>redis-cli <span class="token parameter variable">-a</span> 密码 <span class="token parameter variable">--cluster</span> check 真实ip地址:6381
redis-cli <span class="token parameter variable">-a</span> <span class="token number">111111</span> <span class="token parameter variable">--cluster</span> check <span class="token number">192.168</span>.111.175:6381
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312142084.png" style="zoom:50%;"></li> <li><p>重新分派槽号(reshard )</p> <ul><li><p>重新分派槽号</p></li> <li><p>命令:redis-cli -a 密码 --credis-cli -a 密码 --cluster reshard 192.168.111.175:6381luster <strong>reshard</strong> IP地址:端口号</p></li> <li><p>redis-cli -a 密码 --cluster reshard 192.168.111.175:6381</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312144601.png" style="zoom:50%;"></li></ul></li> <li><p>检查集群情况第2次</p> <ul><li><p>槽号分派说明</p> <p>为什么6387是3个新的区间，以前的还是连续？</p> <p>重新分配成本太高，所以前3家各自匀出来一部分，从6381/6383/6385三个旧节点分别匀出1364个坑位给新节点6387</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312147957.png" style="zoom:67%;"></li></ul></li> <li><p>为主节点6387分配从节点6388</p> <ul><li><p>命令：redis-cli -a 密码 --cluster add-node ip:新slave端口 ip:新master端口 --cluster-slave --cluster-master-id 新主机节点ID</p></li> <li><p>redis-cli -a 111111 --cluster add-node 192.168.111.174:6388 192.168.111.174:6387 --cluster-slave --cluster-master-id 4feb6a7ee0ed2b39ff86474cf4189ab2a554a40f-------这个是6387的编号，按照自己实际情况</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312149159.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312149785.png" alt=""></p></li></ul></li> <li><p>检查集群情况第3次</p> <ul><li><p>redis-cli --cluster check 真实ip地址:6381</p></li> <li><p>redis-cli -a 111111 --cluster check 192.168.111.175:6381</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202408312150404.png" style="zoom:67%;"></li></ul></li></ul></li></ul> <h4 id="_3-5-5-主从缩容案例"><a href="#_3-5-5-主从缩容案例" class="header-anchor">#</a> 3.5.5 主从缩容案例</h4> <ul><li><p>目的：6387和6388下线</p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022113697.png" alt=""></p></li> <li><p>检查集群情况第一次，先获得从节点6388的节点ID</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>redis-cli <span class="token parameter variable">-a</span> 密码 <span class="token parameter variable">--cluster</span> check <span class="token number">192.168</span>.111.174:6388
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022114038.png" style="zoom:67%;"></li> <li><p>从集群中将4号从节点6388删除</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>命令：redis-cli <span class="token parameter variable">-a</span> 密码 <span class="token parameter variable">--cluster</span> del-node ip:从机端口 从机6388节点ID
redis-cli <span class="token parameter variable">-a</span> <span class="token number">111111</span> <span class="token parameter variable">--cluster</span> del-node <span class="token number">192.168</span>.111.174:6388 218e7b8b4f81be54ff173e4776b4f4faaf7c13da
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022115605.png" alt=""></p> <p>检查一下发现，6388被删除了，只剩下7台机器了。</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022116467.png" style="zoom:50%;"></li> <li><p>将6387的槽号清空，重新分配，本例将清出来的槽号都给6381</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>redis-cli <span class="token parameter variable">-a</span> <span class="token number">111111</span> <span class="token parameter variable">--cluster</span> reshard <span class="token number">192.168</span>.111.175:6381
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022120324.png" alt=""></p> <p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022120911.png" alt=""></p></li> <li><p>检查集群情况第二次</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>redis-cli <span class="token parameter variable">-a</span> <span class="token number">111111</span> <span class="token parameter variable">--cluster</span> check <span class="token number">192.168</span>.111.175:6381
<span class="token number">4096</span>个槽位都指给6381，它变成了8192个槽位，相当于全部都给6381了，不然要输入3次，一锅端
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022121994.png" alt=""></p></li> <li><p>将6387删除</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>命令：redis-cli <span class="token parameter variable">-a</span> 密码 <span class="token parameter variable">--cluster</span> del-node ip:端口 <span class="token number">6387</span>节点ID
redis-cli <span class="token parameter variable">-a</span> <span class="token number">111111</span> <span class="token parameter variable">--cluster</span> del-node <span class="token number">192.168</span>.111.174:6387 4feb6a7ee0ed2b39ff86474cf4189ab2a554a40f
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022122676.png" alt=""></p></li> <li><p>检查集群情况第三次,6387/6388被彻底祛除</p> <div class="language-shell line-numbers-mode"><pre class="language-shell"><code>redis-cli <span class="token parameter variable">-a</span> <span class="token number">111111</span> <span class="token parameter variable">--cluster</span> check <span class="token number">192.168</span>.111.175:6381
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022123649.png" alt=""></p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022123307.png" style="zoom:50%;"></li></ul> <h3 id="_3-6-集群常用操作命令和crc16算法分析"><a href="#_3-6-集群常用操作命令和crc16算法分析" class="header-anchor">#</a> 3.6 集群常用操作命令和CRC16算法分析</h3> <ul><li><p>不在同一个slot槽位下的多键操作支持不好，通识占位符登场</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022126133.png" style="zoom:67%;"> <p>可以通过{}来定义同一个组的概念，使key中{}内相同内容的键值对放到一个slot槽位去，对照下图类似k1k2k3都映射为x，自然槽位一样</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022129957.png" style="zoom:67%;"></li> <li><p>Redis集群有16384个哈希槽，每个key通过CRC16校验后对16384取模来决定放置哪个槽。集群的每个节点负责一部分hash槽</p></li> <li><p>常用命令</p> <ul><li><p>集群是否完整才能对外提供服务</p> <img src="https://cdn.jsdelivr.net/gh/clxmm/image/img/2024/08/redis-cluster202409022130965.png" style="zoom:67%;"> <p>默认YES，现在集群架构是3主3从的redis cluster由3个master平分16384个slot，每个master的小集群负责1/3的slot，对应一部分数据。cluster-require-full-coverage： 默认值 yes , 即需要集群完整性，方可对外提供服务 通常情况，如果这3个小集群中，任何一个（1主1从）挂了，你这个集群对外可提供的数据只有2/3了， 整个集群是不完整的， redis 默认在这种情况下，是不会对外提供服务的。</p> <p>如果你的诉求是，集群不完整的话也需要对外提供服务，需要将该参数设置为no ，这样的话你挂了的那个小集群是不行了，但是其他的小集群仍然可以对外提供服务。</p></li> <li><p>CLUSTER COUNTKEYSINSLOT 槽位数字编号</p> <ul><li>1，该槽位被占用</li> <li>0，该槽位没占用</li></ul></li> <li><p>CLUSTER KEYSLOT 键名称</p> <ul><li>该键应该存在哪个槽位上</li></ul></li></ul></li></ul></div></div> <!----> <div class="page-edit"><div class="edit-link"><a href="https://github.com/clxmm/clxmm/edit/master/docs/01.后端学习/10.redis/07.redis集群.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="tags"><a href="/tags/?tag=redis" title="标签">#redis</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2024/09/02, 21:49:24</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/9788da/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">06Redis哨兵(sentinel)</div></a> <a href="/pages/ebe3c7/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">08redis与SpringBoot集成</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/9788da/" class="prev">06Redis哨兵(sentinel)</a></span> <span class="next"><a href="/pages/ebe3c7/">08redis与SpringBoot集成</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/5f5ab3/"><div>
            vue3
            <!----></div></a> <span class="date">01-24</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/7908dd/"><div>
            vue3
            <!----></div></a> <span class="date">01-18</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/910977/"><div>
            vue3
            <!----></div></a> <span class="date">01-08</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><!----> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2024-2025
    <span>Evan Xu | <a href="https://github.com/clxmm" target="_blank">MIT License</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.6504b631.js" defer></script><script src="/assets/js/2.c9184447.js" defer></script><script src="/assets/js/3.b86c239d.js" defer></script><script src="/assets/js/17.d2137085.js" defer></script>
  </body>
</html>
